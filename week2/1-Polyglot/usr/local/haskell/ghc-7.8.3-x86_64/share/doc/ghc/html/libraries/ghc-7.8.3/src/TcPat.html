<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>typecheck/TcPat.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The University of Glasgow 2006
% (c) The GRASP/AQUA Project, Glasgow University, 1992-1998
%

TcPat: Typechecking patterns

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>{-# OPTIONS -fno-warn-tabs #-}</span>
<a name="line-2"></a><span class='hs-comment'>-- The above warning supression flag is a temporary kludge.</span>
<a name="line-3"></a><span class='hs-comment'>-- While working on this module you are encouraged to remove it and</span>
<a name="line-4"></a><span class='hs-comment'>-- detab the module (please do the detabbing in a separate patch). See</span>
<a name="line-5"></a><span class='hs-comment'>--     <a href="http://ghc.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces">http://ghc.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces</a></span>
<a name="line-6"></a><span class='hs-comment'>-- for details</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>TcPat</span> <span class='hs-layout'>(</span> <span class='hs-varid'>tcLetPat</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcSigFun</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcPragFun</span>
<a name="line-9"></a>             <span class='hs-layout'>,</span> <span class='hs-conid'>TcSigInfo</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>findScopedTyVars</span>
<a name="line-10"></a>             <span class='hs-layout'>,</span> <span class='hs-conid'>LetBndrSpec</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>addInlinePrags</span><span class='hs-layout'>,</span> <span class='hs-varid'>warnPrags</span>
<a name="line-11"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>tcPat</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcPats</span><span class='hs-layout'>,</span> <span class='hs-varid'>newNoSigLetBndr</span>
<a name="line-12"></a>	     <span class='hs-layout'>,</span> <span class='hs-varid'>addDataConStupidTheta</span><span class='hs-layout'>,</span> <span class='hs-varid'>badFieldCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>polyPatSig</span> <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-13"></a>
<a name="line-14"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-15"></a>
<a name="line-16"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span>	<span class='hs-conid'>TcExpr</span><span class='hs-layout'>(</span> <span class='hs-varid'>tcSyntaxOp</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcInferRho</span><span class='hs-layout'>)</span>
<a name="line-17"></a>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HsSyn</span>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcHsSyn</span>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnMonad</span>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Inst</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Id</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NameSet</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEnv</span>
<a name="line-27"></a><span class='hs-comment'>--import TcExpr</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcMType</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcValidity</span><span class='hs-layout'>(</span> <span class='hs-varid'>arityErr</span> <span class='hs-layout'>)</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcType</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcUnify</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcHsType</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TysWiredIn</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEvidence</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DataCon</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PatSyn</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ConLike</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrelNames</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span> <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span><span class='hs-conid'>SuccessFlag</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>
</pre>\end{code}


%************************************************************************
%*									*
		External interface
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="tcLetPat"></a><span class='hs-definition'>tcLetPat</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcSigFun</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LetBndrSpec</span>
<a name="line-2"></a>      	 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LPat</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigmaType</span> 
<a name="line-3"></a>     	 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-4"></a>      	 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LPat</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-5"></a><span class='hs-definition'>tcLetPat</span> <span class='hs-varid'>sig_fn</span> <span class='hs-varid'>no_gen</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>pat_ty</span> <span class='hs-varid'>thing_inside</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_lpat</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>pat_ty</span> <span class='hs-varid'>penv</span> <span class='hs-varid'>thing_inside</span> 
<a name="line-7"></a>  <span class='hs-keyword'>where</span>
<a name="line-8"></a>    <span class='hs-varid'>penv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PE</span> <span class='hs-layout'>{</span> <span class='hs-varid'>pe_lazy</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-9"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>pe_ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LetPat</span> <span class='hs-varid'>sig_fn</span> <span class='hs-varid'>no_gen</span> <span class='hs-layout'>}</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="tcPats"></a><span class='hs-comment'>-----------------</span>
<a name="line-12"></a><span class='hs-definition'>tcPats</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsMatchContext</span> <span class='hs-conid'>Name</span>
<a name="line-13"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LPat</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>		 <span class='hs-comment'>-- Patterns,</span>
<a name="line-14"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcSigmaType</span><span class='hs-keyglyph'>]</span>	         <span class='hs-comment'>--   and their types</span>
<a name="line-15"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>                  <span class='hs-comment'>--   and the checker for the body</span>
<a name="line-16"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>LPat</span> <span class='hs-conid'>TcId</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-17"></a>
<a name="line-18"></a><span class='hs-comment'>-- This is the externally-callable wrapper function</span>
<a name="line-19"></a><span class='hs-comment'>-- Typecheck the patterns, extend the environment to bind the variables,</span>
<a name="line-20"></a><span class='hs-comment'>-- do the thing inside, use any existentially-bound dictionaries to </span>
<a name="line-21"></a><span class='hs-comment'>-- discharge parts of the returning LIE, and deal with pattern type</span>
<a name="line-22"></a><span class='hs-comment'>-- signatures</span>
<a name="line-23"></a>
<a name="line-24"></a><span class='hs-comment'>--   1. Initialise the PatState</span>
<a name="line-25"></a><span class='hs-comment'>--   2. Check the patterns</span>
<a name="line-26"></a><span class='hs-comment'>--   3. Check the body</span>
<a name="line-27"></a><span class='hs-comment'>--   4. Check that no existentials escape</span>
<a name="line-28"></a>
<a name="line-29"></a><span class='hs-definition'>tcPats</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>pats</span> <span class='hs-varid'>pat_tys</span> <span class='hs-varid'>thing_inside</span>
<a name="line-30"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_lpats</span> <span class='hs-varid'>penv</span> <span class='hs-varid'>pats</span> <span class='hs-varid'>pat_tys</span> <span class='hs-varid'>thing_inside</span>
<a name="line-31"></a>  <span class='hs-keyword'>where</span>
<a name="line-32"></a>    <span class='hs-varid'>penv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PE</span> <span class='hs-layout'>{</span> <span class='hs-varid'>pe_lazy</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-varid'>pe_ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LamPat</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>}</span>
<a name="line-33"></a>
<a name="line-34"></a><a name="tcPat"></a><span class='hs-definition'>tcPat</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsMatchContext</span> <span class='hs-conid'>Name</span>
<a name="line-35"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LPat</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigmaType</span> 
<a name="line-36"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>                 <span class='hs-comment'>-- Checker for body, given</span>
<a name="line-37"></a>                               <span class='hs-comment'>-- its result type</span>
<a name="line-38"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LPat</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-39"></a><span class='hs-definition'>tcPat</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>pat_ty</span> <span class='hs-varid'>thing_inside</span>
<a name="line-40"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_lpat</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>pat_ty</span> <span class='hs-varid'>penv</span> <span class='hs-varid'>thing_inside</span>
<a name="line-41"></a>  <span class='hs-keyword'>where</span>
<a name="line-42"></a>    <span class='hs-varid'>penv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PE</span> <span class='hs-layout'>{</span> <span class='hs-varid'>pe_lazy</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-varid'>pe_ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LamPat</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>}</span>
<a name="line-43"></a>   
<a name="line-44"></a>
<a name="line-45"></a><a name="PatEnv"></a><span class='hs-comment'>-----------------</span>
<a name="line-46"></a><a name="PatEnv"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>PatEnv</span>
<a name="line-47"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PE</span> <span class='hs-layout'>{</span> <span class='hs-varid'>pe_lazy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>	<span class='hs-comment'>-- True &lt;=&gt; lazy context, so no existentials allowed</span>
<a name="line-48"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>pe_ctxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PatCtxt</span>   	<span class='hs-comment'>-- Context in which the whole pattern appears</span>
<a name="line-49"></a>       <span class='hs-layout'>}</span>
<a name="line-50"></a>
<a name="line-51"></a><a name="PatCtxt"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>PatCtxt</span>
<a name="line-52"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LamPat</span>   <span class='hs-comment'>-- Used for lambdas, case etc</span>
<a name="line-53"></a>       <span class='hs-layout'>(</span><span class='hs-conid'>HsMatchContext</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span> 
<a name="line-54"></a>
<a name="line-55"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>LetPat</span>   <span class='hs-comment'>-- Used only for let(rec) pattern bindings</span>
<a name="line-56"></a>    	     <span class='hs-comment'>-- See Note [Typing patterns in pattern bindings]</span>
<a name="line-57"></a>       <span class='hs-conid'>TcSigFun</span>        <span class='hs-comment'>-- Tells type sig if any</span>
<a name="line-58"></a>       <span class='hs-conid'>LetBndrSpec</span>     <span class='hs-comment'>-- True &lt;=&gt; no generalisation of this let</span>
<a name="line-59"></a>
<a name="line-60"></a><a name="LetBndrSpec"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>LetBndrSpec</span> 
<a name="line-61"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LetLclBndr</span>		  <span class='hs-comment'>-- The binder is just a local one;</span>
<a name="line-62"></a>    			  <span class='hs-comment'>-- an AbsBinds will provide the global version</span>
<a name="line-63"></a>
<a name="line-64"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>LetGblBndr</span> <span class='hs-conid'>TcPragFun</span>  <span class='hs-comment'>-- Genrealisation plan is NoGen, so there isn't going </span>
<a name="line-65"></a>                          <span class='hs-comment'>-- to be an AbsBinds; So we must bind the global version</span>
<a name="line-66"></a>                          <span class='hs-comment'>-- of the binder right away.  </span>
<a name="line-67"></a>    	       		  <span class='hs-comment'>-- Oh, and dhhere is the inline-pragma information</span>
<a name="line-68"></a>
<a name="line-69"></a><a name="makeLazy"></a><span class='hs-definition'>makeLazy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PatEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PatEnv</span>
<a name="line-70"></a><span class='hs-definition'>makeLazy</span> <span class='hs-varid'>penv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>penv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>pe_lazy</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span> <span class='hs-layout'>}</span>
<a name="line-71"></a>
<a name="line-72"></a><a name="patSigCtxt"></a><span class='hs-definition'>patSigCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PatEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UserTypeCtxt</span>
<a name="line-73"></a><span class='hs-definition'>patSigCtxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>PE</span> <span class='hs-layout'>{</span> <span class='hs-varid'>pe_ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LetPat</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>BindPatSigCtxt</span>
<a name="line-74"></a><span class='hs-definition'>patSigCtxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>PE</span> <span class='hs-layout'>{</span> <span class='hs-varid'>pe_ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LamPat</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LamPatSigCtxt</span>
<a name="line-75"></a>
<a name="line-76"></a><a name="TcPragFun"></a><span class='hs-comment'>---------------</span>
<a name="line-77"></a><a name="TcPragFun"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcPragFun</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LSig</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-78"></a><a name="TcSigFun"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcSigFun</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TcSigInfo</span>
<a name="line-79"></a>
<a name="line-80"></a><a name="TcSigInfo"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TcSigInfo</span>
<a name="line-81"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcSigInfo</span> <span class='hs-layout'>{</span>
<a name="line-82"></a>        <span class='hs-varid'>sig_id</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>,</span>         <span class='hs-comment'>--  *Polymorphic* binder for this value...</span>
<a name="line-83"></a>
<a name="line-84"></a>        <span class='hs-varid'>sig_tvs</span>    <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcTyVar</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>    
<a name="line-85"></a>                           <span class='hs-comment'>-- Instantiated type and kind variables</span>
<a name="line-86"></a>                           <span class='hs-comment'>-- Just n &lt;=&gt; this skolem is lexically in scope with name n</span>
<a name="line-87"></a>                           <span class='hs-comment'>-- See Note [Binding scoped type variables]</span>
<a name="line-88"></a>
<a name="line-89"></a>        <span class='hs-varid'>sig_theta</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcThetaType</span><span class='hs-layout'>,</span>  <span class='hs-comment'>-- Instantiated theta</span>
<a name="line-90"></a>
<a name="line-91"></a>        <span class='hs-varid'>sig_tau</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcSigmaType</span><span class='hs-layout'>,</span>  <span class='hs-comment'>-- Instantiated tau</span>
<a name="line-92"></a>		      		    <span class='hs-comment'>-- See Note [sig_tau may be polymorphic]</span>
<a name="line-93"></a>
<a name="line-94"></a>        <span class='hs-varid'>sig_loc</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcSpan</span>       <span class='hs-comment'>-- The location of the signature</span>
<a name="line-95"></a>    <span class='hs-layout'>}</span>
<a name="line-96"></a>
<a name="line-97"></a><a name="findScopedTyVars"></a><span class='hs-definition'>findScopedTyVars</span>  <span class='hs-comment'>-- See Note [Binding scoped type variables]</span>
<a name="line-98"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span>             <span class='hs-comment'>-- The HsType</span>
<a name="line-99"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>                   <span class='hs-comment'>-- The corresponding Type:</span>
<a name="line-100"></a>                              <span class='hs-comment'>--   uses same Names as the HsType</span>
<a name="line-101"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span>                <span class='hs-comment'>-- The instantiated forall variables of the Type</span>
<a name="line-102"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcTyVar</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- In 1-1 correspondence with the instantiated vars</span>
<a name="line-103"></a><span class='hs-definition'>findScopedTyVars</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>sig_ty</span> <span class='hs-varid'>inst_tvs</span>
<a name="line-104"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWith</span> <span class='hs-varid'>find</span> <span class='hs-varid'>sig_tvs</span> <span class='hs-varid'>inst_tvs</span>
<a name="line-105"></a>  <span class='hs-keyword'>where</span>
<a name="line-106"></a>    <span class='hs-varid'>find</span> <span class='hs-varid'>sig_tv</span> <span class='hs-varid'>inst_tv</span>
<a name="line-107"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tv_name</span> <span class='hs-varop'>`elemNameSet`</span> <span class='hs-varid'>scoped_names</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>tv_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>inst_tv</span><span class='hs-layout'>)</span>
<a name="line-108"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                          <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span>      <span class='hs-varid'>inst_tv</span><span class='hs-layout'>)</span>
<a name="line-109"></a>      <span class='hs-keyword'>where</span>
<a name="line-110"></a>        <span class='hs-varid'>tv_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarName</span> <span class='hs-varid'>sig_tv</span>
<a name="line-111"></a>
<a name="line-112"></a>    <span class='hs-varid'>scoped_names</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNameSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsExplicitTvs</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>)</span>
<a name="line-113"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>sig_tvs</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitForAllTys</span> <span class='hs-varid'>sig_ty</span>
<a name="line-114"></a>
<a name="line-115"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>TcSigInfo</span> <span class='hs-keyword'>where</span>
<a name="line-116"></a>    <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcSigInfo</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sig_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>id</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyvars</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_theta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_tau</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tau</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-117"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>id</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>pprSigmaType</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkSigmaTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>snd</span> <span class='hs-varid'>tyvars</span><span class='hs-layout'>)</span> <span class='hs-varid'>theta</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span>
<a name="line-118"></a>                                     <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>tyvars</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
</pre>\end{code}

Note [Binding scoped type variables]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The type variables *brought into lexical scope* by a type signature may
be a subset of the *quantified type variables* of the signatures, for two reasons:

* With kind polymorphism a signature like
    f :: forall f a. f a -> f a
  may actuallly give rise to
    f :: forall k. forall (f::k -> *) (a:k). f a -> f a
  So the sig_tvs will be [k,f,a], but only f,a are scoped.
  NB: the scoped ones are not necessarily the *inital* ones!

* Even aside from kind polymorphism, tere may be more instantiated
  type variables than lexically-scoped ones.  For example:
        type T a = forall b. b -> (a,b)
        f :: forall c. T c
  Here, the signature for f will have one scoped type variable, c,
  but two instantiated type variables, c' and b'.

The function findScopedTyVars takes
  * hs_ty:    the original HsForAllTy
  * sig_ty:   the corresponding Type (which is guaranteed to use the same Names
              as the HsForAllTy)
  * inst_tvs: the skolems instantiated from the forall's in sig_ty
It returns a [(Maybe Name, TcTyVar)], in 1-1 correspondence with inst_tvs
but with a (Just n) for the lexically scoped name of each in-scope tyvar.

Note [sig_tau may be polymorphic]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Note that "sig_tau" might actually be a polymorphic type,
if the original function had a signature like
   forall a. Eq a => forall b. Ord b => ....
But that's ok: tcMatchesFun (called by tcRhs) can deal with that
It happens, too!  See Note [Polymorphic methods] in TcClassDcl.

Note [Existential check]
~~~~~~~~~~~~~~~~~~~~~~~~
Lazy patterns can't bind existentials.  They arise in two ways:
  * Let bindings      let { C a b = e } in b
  * Twiddle patterns  f ~(C a b) = e
The pe_lazy field of PatEnv says whether we are inside a lazy
pattern (perhaps deeply)

If we aren't inside a lazy pattern then we can bind existentials,
but we need to be careful about "extra" tyvars. Consider
    (\C x -> d) : pat_ty -> res_ty
When looking for existential escape we must check that the existential
bound by C don't unify with the free variables of pat_ty, OR res_ty
(or of course the environment).   Hence we need to keep track of the 
res_ty free vars.


%************************************************************************
%*									*
		Binders
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="tcPatBndr"></a><span class='hs-definition'>tcPatBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PatEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigmaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCoercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span>
<a name="line-2"></a><span class='hs-comment'>-- (coi, xp) = tcPatBndr penv x pat_ty</span>
<a name="line-3"></a><span class='hs-comment'>-- Then coi : pat_ty ~ typeof(xp)</span>
<a name="line-4"></a><span class='hs-comment'>--</span>
<a name="line-5"></a><span class='hs-definition'>tcPatBndr</span> <span class='hs-layout'>(</span><span class='hs-conid'>PE</span> <span class='hs-layout'>{</span> <span class='hs-varid'>pe_ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LetPat</span> <span class='hs-varid'>lookup_sig</span> <span class='hs-varid'>no_gen</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>bndr_name</span> <span class='hs-varid'>pat_ty</span>
<a name="line-6"></a>          <span class='hs-comment'>-- See Note [Typing patterns in pattern bindings]</span>
<a name="line-7"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>LetGblBndr</span> <span class='hs-varid'>prags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>no_gen</span>
<a name="line-8"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>sig</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookup_sig</span> <span class='hs-varid'>bndr_name</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>bndr_id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>addInlinePrags</span> <span class='hs-layout'>(</span><span class='hs-varid'>sig_id</span> <span class='hs-varid'>sig</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>prags</span> <span class='hs-varid'>bndr_name</span><span class='hs-layout'>)</span>
<a name="line-10"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcPatBndr(gbl,sig)"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>bndr_id</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>bndr_id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> 
<a name="line-11"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unifyPatType</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>bndr_id</span><span class='hs-layout'>)</span> <span class='hs-varid'>pat_ty</span>
<a name="line-12"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndr_id</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-13"></a>      
<a name="line-14"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> 
<a name="line-15"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>bndr_id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newNoSigLetBndr</span> <span class='hs-varid'>no_gen</span> <span class='hs-varid'>bndr_name</span> <span class='hs-varid'>pat_ty</span>
<a name="line-16"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcPatBndr(no-sig)"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>bndr_id</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>bndr_id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-17"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcNomReflCo</span> <span class='hs-varid'>pat_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndr_id</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-18"></a>
<a name="line-19"></a><span class='hs-definition'>tcPatBndr</span> <span class='hs-layout'>(</span><span class='hs-conid'>PE</span> <span class='hs-layout'>{</span> <span class='hs-varid'>pe_ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-sel'>_lam_or_proc</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>bndr_name</span> <span class='hs-varid'>pat_ty</span>
<a name="line-20"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>bndr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkLocalBinder</span> <span class='hs-varid'>bndr_name</span> <span class='hs-varid'>pat_ty</span>
<a name="line-21"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcNomReflCo</span> <span class='hs-varid'>pat_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-22"></a>
<a name="line-23"></a><a name="newNoSigLetBndr"></a><span class='hs-comment'>------------</span>
<a name="line-24"></a><span class='hs-definition'>newNoSigLetBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LetBndrSpec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcId</span>
<a name="line-25"></a><span class='hs-comment'>-- In the polymorphic case (no_gen = LetLclBndr), generate a "monomorphic version" </span>
<a name="line-26"></a><span class='hs-comment'>--    of the Id; the original name will be bound to the polymorphic version</span>
<a name="line-27"></a><span class='hs-comment'>--    by the AbsBinds</span>
<a name="line-28"></a><span class='hs-comment'>-- In the monomorphic case (no_gen = LetBglBndr) there is no AbsBinds, and we </span>
<a name="line-29"></a><span class='hs-comment'>--    use the original name directly</span>
<a name="line-30"></a><span class='hs-definition'>newNoSigLetBndr</span> <span class='hs-conid'>LetLclBndr</span> <span class='hs-varid'>name</span> <span class='hs-varid'>ty</span> 
<a name="line-31"></a>  <span class='hs-keyglyph'>=</span><span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>mono_name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newLocalName</span> <span class='hs-varid'>name</span>
<a name="line-32"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mkLocalBinder</span> <span class='hs-varid'>mono_name</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>}</span>
<a name="line-33"></a><span class='hs-definition'>newNoSigLetBndr</span> <span class='hs-layout'>(</span><span class='hs-conid'>LetGblBndr</span> <span class='hs-varid'>prags</span><span class='hs-layout'>)</span> <span class='hs-varid'>name</span> <span class='hs-varid'>ty</span> 
<a name="line-34"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkLocalBinder</span> <span class='hs-varid'>name</span> <span class='hs-varid'>ty</span>
<a name="line-35"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>addInlinePrags</span> <span class='hs-varid'>id</span> <span class='hs-layout'>(</span><span class='hs-varid'>prags</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-36"></a>
<a name="line-37"></a><a name="addInlinePrags"></a><span class='hs-comment'>----------</span>
<a name="line-38"></a><span class='hs-definition'>addInlinePrags</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LSig</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcId</span>
<a name="line-39"></a><span class='hs-definition'>addInlinePrags</span> <span class='hs-varid'>poly_id</span> <span class='hs-varid'>prags</span>
<a name="line-40"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"addInlinePrags"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>poly_id</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>prags</span><span class='hs-layout'>)</span> 
<a name="line-41"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tc_inl</span> <span class='hs-varid'>inl_sigs</span> <span class='hs-layout'>}</span>
<a name="line-42"></a>  <span class='hs-keyword'>where</span>
<a name="line-43"></a>    <span class='hs-varid'>inl_sigs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>isInlineLSig</span> <span class='hs-varid'>prags</span>
<a name="line-44"></a>    <span class='hs-varid'>tc_inl</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>poly_id</span>
<a name="line-45"></a>    <span class='hs-varid'>tc_inl</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>InlineSig</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>prag</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>other_inls</span><span class='hs-layout'>)</span>
<a name="line-46"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>other_inls</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>warn_dup_inline</span><span class='hs-layout'>)</span>
<a name="line-47"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"addInlinePrag"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>poly_id</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>prag</span><span class='hs-layout'>)</span> 
<a name="line-48"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>poly_id</span> <span class='hs-varop'>`setInlinePragma`</span> <span class='hs-varid'>prag</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-49"></a>    <span class='hs-varid'>tc_inl</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"tc_inl"</span>
<a name="line-50"></a>
<a name="line-51"></a>    <span class='hs-varid'>warn_dup_inline</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>warnPrags</span> <span class='hs-varid'>poly_id</span> <span class='hs-varid'>inl_sigs</span> <span class='hs-varop'>$</span>
<a name="line-52"></a>                      <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Duplicate INLINE pragmas for"</span><span class='hs-layout'>)</span>
<a name="line-53"></a>
<a name="line-54"></a><a name="warnPrags"></a><span class='hs-definition'>warnPrags</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LSig</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-55"></a><span class='hs-definition'>warnPrags</span> <span class='hs-varid'>id</span> <span class='hs-varid'>bad_sigs</span> <span class='hs-varid'>herald</span>
<a name="line-56"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addWarnTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>herald</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-57"></a>                  <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr_sigs</span> <span class='hs-varid'>bad_sigs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-58"></a>  <span class='hs-keyword'>where</span>
<a name="line-59"></a>    <span class='hs-varid'>ppr_sigs</span> <span class='hs-varid'>sigs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varop'>.</span> <span class='hs-varid'>getLoc</span><span class='hs-layout'>)</span> <span class='hs-varid'>sigs</span><span class='hs-layout'>)</span>
<a name="line-60"></a>
<a name="line-61"></a><a name="mkLocalBinder"></a><span class='hs-comment'>-----------------</span>
<a name="line-62"></a><span class='hs-definition'>mkLocalBinder</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcId</span>
<a name="line-63"></a><span class='hs-definition'>mkLocalBinder</span> <span class='hs-varid'>name</span> <span class='hs-varid'>ty</span>
<a name="line-64"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-varop'>.</span><span class='hs-varid'>mkLocalId</span> <span class='hs-varid'>name</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
</pre>\end{code}

Note [Typing patterns in pattern bindings]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose we are typing a pattern binding
    pat = rhs
Then the PatCtxt will be (LetPat sig_fn let_bndr_spec).

There can still be signatures for the binders:
     data T = MkT (forall a. a->a) Int
     x :: forall a. a->a
     y :: Int
     MkT x y = <rhs>

Two cases, dealt with by the LetPat case of tcPatBndr

 * If we are generalising (generalisation plan is InferGen or
   CheckGen), then the let_bndr_spec will be LetLclBndr.  In that case
   we want to bind a cloned, local version of the variable, with the
   type given by the pattern context, *not* by the signature (even if
   there is one; see Trac #7268). The mkExport part of the
   generalisation step will do the checking and impedence matching
   against the signature.

 * If for some some reason we are not generalising (plan = NoGen), the
   LetBndrSpec will be LetGblBndr.  In that case we must bind the
   global version of the Id, and do so with precisely the type given
   in the signature.  (Then we unify with the type from the pattern
   context type.


%************************************************************************
%*									*
		The main worker functions
%*									*
%************************************************************************

Note [Nesting]
~~~~~~~~~~~~~~
tcPat takes a "thing inside" over which the pattern scopes.  This is partly
so that tcPat can extend the environment for the thing_inside, but also 
so that constraints arising in the thing_inside can be discharged by the
pattern.

This does not work so well for the ErrCtxt carried by the monad: we don't
want the error-context for the pattern to scope over the RHS. 
Hence the getErrCtxt/setErrCtxt stuff in tcMultiple

\begin{code}
<pre><a name="line-1"></a><a name="Checker"></a><span class='hs-comment'>--------------------</span>
<a name="line-2"></a><a name="Checker"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>Checker</span> <span class='hs-varid'>inp</span> <span class='hs-varid'>out</span> <span class='hs-keyglyph'>=</span>  <span class='hs-keyword'>forall</span> <span class='hs-varid'>r</span><span class='hs-varop'>.</span>
<a name="line-3"></a>			  <span class='hs-varid'>inp</span>
<a name="line-4"></a>		       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PatEnv</span>
<a name="line-5"></a>		       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>r</span>
<a name="line-6"></a>		       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-varid'>out</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-7"></a>
<a name="line-8"></a><a name="tcMultiple"></a><span class='hs-definition'>tcMultiple</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Checker</span> <span class='hs-varid'>inp</span> <span class='hs-varid'>out</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Checker</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>inp</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>out</span><span class='hs-keyglyph'>]</span>
<a name="line-9"></a><span class='hs-definition'>tcMultiple</span> <span class='hs-varid'>tc_pat</span> <span class='hs-varid'>args</span> <span class='hs-varid'>penv</span> <span class='hs-varid'>thing_inside</span>
<a name="line-10"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>err_ctxt</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getErrCtxt</span>
<a name="line-11"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>loop</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span>
<a name="line-12"></a>		<span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span>
<a name="line-13"></a>		     <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-14"></a>
<a name="line-15"></a>	      <span class='hs-varid'>loop</span> <span class='hs-varid'>penv</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg</span><span class='hs-conop'>:</span><span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-16"></a>		<span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>p'</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>ps'</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> 
<a name="line-17"></a>				<span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_pat</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>penv</span> <span class='hs-varop'>$</span> 
<a name="line-18"></a>				   <span class='hs-varid'>setErrCtxt</span> <span class='hs-varid'>err_ctxt</span> <span class='hs-varop'>$</span>
<a name="line-19"></a>				   <span class='hs-varid'>loop</span> <span class='hs-varid'>penv</span> <span class='hs-varid'>args</span>
<a name="line-20"></a>		<span class='hs-comment'>-- setErrCtxt: restore context before doing the next pattern</span>
<a name="line-21"></a>		<span class='hs-comment'>-- See note [Nesting] above</span>
<a name="line-22"></a>				
<a name="line-23"></a>		     <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>p'</span><span class='hs-conop'>:</span><span class='hs-varid'>ps'</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-24"></a>
<a name="line-25"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>loop</span> <span class='hs-varid'>penv</span> <span class='hs-varid'>args</span> <span class='hs-layout'>}</span>
<a name="line-26"></a>
<a name="line-27"></a><a name="tc_lpat"></a><span class='hs-comment'>--------------------</span>
<a name="line-28"></a><span class='hs-definition'>tc_lpat</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LPat</span> <span class='hs-conid'>Name</span> 
<a name="line-29"></a>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigmaType</span>
<a name="line-30"></a>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PatEnv</span>
<a name="line-31"></a>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-32"></a>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LPat</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-33"></a><span class='hs-definition'>tc_lpat</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>span</span> <span class='hs-varid'>pat</span><span class='hs-layout'>)</span> <span class='hs-varid'>pat_ty</span> <span class='hs-varid'>penv</span> <span class='hs-varid'>thing_inside</span>
<a name="line-34"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>span</span> <span class='hs-varop'>$</span>
<a name="line-35"></a>    <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>pat'</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>maybeWrapPatCtxt</span> <span class='hs-varid'>pat</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc_pat</span> <span class='hs-varid'>penv</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>pat_ty</span><span class='hs-layout'>)</span>
<a name="line-36"></a>                                          <span class='hs-varid'>thing_inside</span>
<a name="line-37"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>span</span> <span class='hs-varid'>pat'</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-38"></a>
<a name="line-39"></a><a name="tc_lpats"></a><span class='hs-definition'>tc_lpats</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PatEnv</span>
<a name="line-40"></a>	 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LPat</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcSigmaType</span><span class='hs-keyglyph'>]</span>
<a name="line-41"></a>       	 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>	
<a name="line-42"></a>       	 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>LPat</span> <span class='hs-conid'>TcId</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-43"></a><span class='hs-definition'>tc_lpats</span> <span class='hs-varid'>penv</span> <span class='hs-varid'>pats</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>thing_inside</span> 
<a name="line-44"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>equalLength</span> <span class='hs-varid'>pats</span> <span class='hs-varid'>tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>pats</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>)</span>
<a name="line-45"></a>    <span class='hs-varid'>tcMultiple</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>p</span><span class='hs-layout'>,</span><span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tc_lpat</span> <span class='hs-varid'>p</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> 
<a name="line-46"></a>                <span class='hs-layout'>(</span><span class='hs-varid'>zipEqual</span> <span class='hs-str'>"tc_lpats"</span> <span class='hs-varid'>pats</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-47"></a>                <span class='hs-varid'>penv</span> <span class='hs-varid'>thing_inside</span> 
<a name="line-48"></a>
<a name="line-49"></a><a name="tc_pat"></a><span class='hs-comment'>--------------------</span>
<a name="line-50"></a><span class='hs-definition'>tc_pat</span>	<span class='hs-keyglyph'>::</span> <span class='hs-conid'>PatEnv</span>
<a name="line-51"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Pat</span> <span class='hs-conid'>Name</span> 
<a name="line-52"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigmaType</span>	<span class='hs-comment'>-- Fully refined result type</span>
<a name="line-53"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>		<span class='hs-comment'>-- Thing inside</span>
<a name="line-54"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Pat</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>,</span> 	<span class='hs-comment'>-- Translated pattern</span>
<a name="line-55"></a>                <span class='hs-varid'>a</span><span class='hs-layout'>)</span>		<span class='hs-comment'>-- Result of thing inside</span>
<a name="line-56"></a>
<a name="line-57"></a><span class='hs-definition'>tc_pat</span> <span class='hs-varid'>penv</span> <span class='hs-layout'>(</span><span class='hs-conid'>VarPat</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varid'>pat_ty</span> <span class='hs-varid'>thing_inside</span>
<a name="line-58"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcPatBndr</span> <span class='hs-varid'>penv</span> <span class='hs-varid'>name</span> <span class='hs-varid'>pat_ty</span>
<a name="line-59"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcExtendIdEnv1</span> <span class='hs-varid'>name</span> <span class='hs-varid'>id</span> <span class='hs-varid'>thing_inside</span>
<a name="line-60"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkHsWrapPatCo</span> <span class='hs-varid'>co</span> <span class='hs-layout'>(</span><span class='hs-conid'>VarPat</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-varid'>pat_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-61"></a>
<a name="line-62"></a><span class='hs-definition'>tc_pat</span> <span class='hs-varid'>penv</span> <span class='hs-layout'>(</span><span class='hs-conid'>ParPat</span> <span class='hs-varid'>pat</span><span class='hs-layout'>)</span> <span class='hs-varid'>pat_ty</span> <span class='hs-varid'>thing_inside</span>
<a name="line-63"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>pat'</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lpat</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>pat_ty</span> <span class='hs-varid'>penv</span> <span class='hs-varid'>thing_inside</span>
<a name="line-64"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ParPat</span> <span class='hs-varid'>pat'</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-65"></a>
<a name="line-66"></a><span class='hs-definition'>tc_pat</span> <span class='hs-varid'>penv</span> <span class='hs-layout'>(</span><span class='hs-conid'>BangPat</span> <span class='hs-varid'>pat</span><span class='hs-layout'>)</span> <span class='hs-varid'>pat_ty</span> <span class='hs-varid'>thing_inside</span>
<a name="line-67"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>pat'</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lpat</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>pat_ty</span> <span class='hs-varid'>penv</span> <span class='hs-varid'>thing_inside</span>
<a name="line-68"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>BangPat</span> <span class='hs-varid'>pat'</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-69"></a>
<a name="line-70"></a><span class='hs-definition'>tc_pat</span> <span class='hs-varid'>penv</span> <span class='hs-varid'>lpat</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>LazyPat</span> <span class='hs-varid'>pat</span><span class='hs-layout'>)</span> <span class='hs-varid'>pat_ty</span> <span class='hs-varid'>thing_inside</span>
<a name="line-71"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>pat'</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>res</span><span class='hs-layout'>,</span> <span class='hs-varid'>pat_ct</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> 
<a name="line-72"></a>		<span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lpat</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>pat_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>makeLazy</span> <span class='hs-varid'>penv</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> 
<a name="line-73"></a>		   <span class='hs-varid'>captureConstraints</span> <span class='hs-varid'>thing_inside</span>
<a name="line-74"></a>		<span class='hs-comment'>-- Ignore refined penv', revert to penv</span>
<a name="line-75"></a>
<a name="line-76"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>emitConstraints</span> <span class='hs-varid'>pat_ct</span>
<a name="line-77"></a>	<span class='hs-comment'>-- captureConstraints/extendConstraints: </span>
<a name="line-78"></a>        <span class='hs-comment'>--   see Note [Hopping the LIE in lazy patterns]</span>
<a name="line-79"></a>
<a name="line-80"></a>	<span class='hs-comment'>-- Check there are no unlifted types under the lazy pattern</span>
<a name="line-81"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-varid'>isUnLiftedType</span> <span class='hs-varop'>.</span> <span class='hs-varid'>idType</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>collectPatBinders</span> <span class='hs-varid'>pat'</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-82"></a>               <span class='hs-varid'>lazyUnliftedPatErr</span> <span class='hs-varid'>lpat</span>
<a name="line-83"></a>
<a name="line-84"></a>	<span class='hs-comment'>-- Check that the expected pattern type is itself lifted</span>
<a name="line-85"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>pat_ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-86"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unifyType</span> <span class='hs-varid'>pat_ty</span> <span class='hs-varid'>pat_ty'</span>
<a name="line-87"></a>
<a name="line-88"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>LazyPat</span> <span class='hs-varid'>pat'</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-89"></a>
<a name="line-90"></a><span class='hs-definition'>tc_pat</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>p</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>QuasiQuotePat</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>
<a name="line-91"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"Should never see QuasiQuotePat in type checker"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span>
<a name="line-92"></a>
<a name="line-93"></a><span class='hs-definition'>tc_pat</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>WildPat</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>pat_ty</span> <span class='hs-varid'>thing_inside</span>
<a name="line-94"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span> 
<a name="line-95"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>WildPat</span> <span class='hs-varid'>pat_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-96"></a>
<a name="line-97"></a><span class='hs-definition'>tc_pat</span> <span class='hs-varid'>penv</span> <span class='hs-layout'>(</span><span class='hs-conid'>AsPat</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>nm_loc</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varid'>pat</span><span class='hs-layout'>)</span> <span class='hs-varid'>pat_ty</span> <span class='hs-varid'>thing_inside</span>
<a name="line-98"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndr_id</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>nm_loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcPatBndr</span> <span class='hs-varid'>penv</span> <span class='hs-varid'>name</span> <span class='hs-varid'>pat_ty</span><span class='hs-layout'>)</span>
<a name="line-99"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>pat'</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcExtendIdEnv1</span> <span class='hs-varid'>name</span> <span class='hs-varid'>bndr_id</span> <span class='hs-varop'>$</span>
<a name="line-100"></a>			 <span class='hs-varid'>tc_lpat</span> <span class='hs-varid'>pat</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>bndr_id</span><span class='hs-layout'>)</span> <span class='hs-varid'>penv</span> <span class='hs-varid'>thing_inside</span>
<a name="line-101"></a>	    <span class='hs-comment'>-- NB: if we do inference on:</span>
<a name="line-102"></a>	    <span class='hs-comment'>--		\ (y@(x::forall a. a-&gt;a)) = e</span>
<a name="line-103"></a>	    <span class='hs-comment'>-- we'll fail.  The as-pattern infers a monotype for 'y', which then</span>
<a name="line-104"></a>	    <span class='hs-comment'>-- fails to unify with the polymorphic type for 'x'.  This could </span>
<a name="line-105"></a>	    <span class='hs-comment'>-- perhaps be fixed, but only with a bit more work.</span>
<a name="line-106"></a>	    <span class='hs-comment'>--</span>
<a name="line-107"></a>	    <span class='hs-comment'>-- If you fix it, don't forget the bindInstsOfPatIds!</span>
<a name="line-108"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkHsWrapPatCo</span> <span class='hs-varid'>co</span> <span class='hs-layout'>(</span><span class='hs-conid'>AsPat</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>nm_loc</span> <span class='hs-varid'>bndr_id</span><span class='hs-layout'>)</span> <span class='hs-varid'>pat'</span><span class='hs-layout'>)</span> <span class='hs-varid'>pat_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-109"></a>
<a name="line-110"></a><span class='hs-definition'>tc_pat</span> <span class='hs-varid'>penv</span> <span class='hs-layout'>(</span><span class='hs-conid'>ViewPat</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>pat</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>overall_pat_ty</span> <span class='hs-varid'>thing_inside</span> 
<a name="line-111"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span>
<a name="line-112"></a>         <span class='hs-comment'>-- Morally, expr must have type `forall a1...aN. OPT' -&gt; B` </span>
<a name="line-113"></a>         <span class='hs-comment'>-- where overall_pat_ty is an instance of OPT'.</span>
<a name="line-114"></a>         <span class='hs-comment'>-- Here, we infer a rho type for it,</span>
<a name="line-115"></a>         <span class='hs-comment'>-- which replaces the leading foralls and constraints</span>
<a name="line-116"></a>         <span class='hs-comment'>-- with fresh unification variables.</span>
<a name="line-117"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>expr'</span><span class='hs-layout'>,</span><span class='hs-varid'>expr'_inferred</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInferRho</span> <span class='hs-varid'>expr</span>
<a name="line-118"></a>
<a name="line-119"></a>         <span class='hs-comment'>-- next, we check that expr is coercible to `overall_pat_ty -&gt; pat_ty`</span>
<a name="line-120"></a>         <span class='hs-comment'>-- NOTE: this forces pat_ty to be a monotype (because we use a unification </span>
<a name="line-121"></a>         <span class='hs-comment'>-- variable to find it).  this means that in an example like</span>
<a name="line-122"></a>         <span class='hs-comment'>-- (view -&gt; f)    where view :: _ -&gt; forall b. b</span>
<a name="line-123"></a>         <span class='hs-comment'>-- we will only be able to use view at one instantation in the</span>
<a name="line-124"></a>         <span class='hs-comment'>-- rest of the view</span>
<a name="line-125"></a>	<span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>expr_co</span><span class='hs-layout'>,</span> <span class='hs-varid'>pat_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInfer</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>pat_ty</span> <span class='hs-keyglyph'>-&gt;</span> 
<a name="line-126"></a>		<span class='hs-varid'>unifyType</span> <span class='hs-varid'>expr'_inferred</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFunTy</span> <span class='hs-varid'>overall_pat_ty</span> <span class='hs-varid'>pat_ty</span><span class='hs-layout'>)</span>
<a name="line-127"></a>        
<a name="line-128"></a>         <span class='hs-comment'>-- pattern must have pat_ty</span>
<a name="line-129"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>pat'</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lpat</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>pat_ty</span> <span class='hs-varid'>penv</span> <span class='hs-varid'>thing_inside</span>
<a name="line-130"></a>
<a name="line-131"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ViewPat</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLHsWrapCo</span> <span class='hs-varid'>expr_co</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span> <span class='hs-varid'>pat'</span> <span class='hs-varid'>overall_pat_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-132"></a>
<a name="line-133"></a><span class='hs-comment'>-- Type signatures in patterns</span>
<a name="line-134"></a><span class='hs-comment'>-- See Note [Pattern coercions] below</span>
<a name="line-135"></a><span class='hs-definition'>tc_pat</span> <span class='hs-varid'>penv</span> <span class='hs-layout'>(</span><span class='hs-conid'>SigPatIn</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>pat_ty</span> <span class='hs-varid'>thing_inside</span>
<a name="line-136"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>inner_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv_binds</span><span class='hs-layout'>,</span> <span class='hs-varid'>wrap</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcPatSig</span> <span class='hs-layout'>(</span><span class='hs-varid'>patSigCtxt</span> <span class='hs-varid'>penv</span><span class='hs-layout'>)</span> <span class='hs-varid'>sig_ty</span> <span class='hs-varid'>pat_ty</span>
<a name="line-137"></a>	<span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>pat'</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcExtendTyVarEnv2</span> <span class='hs-varid'>tv_binds</span> <span class='hs-varop'>$</span>
<a name="line-138"></a>			 <span class='hs-varid'>tc_lpat</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>inner_ty</span> <span class='hs-varid'>penv</span> <span class='hs-varid'>thing_inside</span>
<a name="line-139"></a>
<a name="line-140"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkHsWrapPat</span> <span class='hs-varid'>wrap</span> <span class='hs-layout'>(</span><span class='hs-conid'>SigPatOut</span> <span class='hs-varid'>pat'</span> <span class='hs-varid'>inner_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>pat_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-141"></a>
<a name="line-142"></a><span class='hs-comment'>------------------------</span>
<a name="line-143"></a><span class='hs-comment'>-- Lists, tuples, arrays</span>
<a name="line-144"></a><span class='hs-definition'>tc_pat</span> <span class='hs-varid'>penv</span> <span class='hs-layout'>(</span><span class='hs-conid'>ListPat</span> <span class='hs-varid'>pats</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span> <span class='hs-varid'>pat_ty</span> <span class='hs-varid'>thing_inside</span>
<a name="line-145"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>coi</span><span class='hs-layout'>,</span> <span class='hs-varid'>elt_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>matchExpectedPatTy</span> <span class='hs-varid'>matchExpectedListTy</span> <span class='hs-varid'>pat_ty</span>      
<a name="line-146"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>pats'</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMultiple</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>p</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tc_lpat</span> <span class='hs-varid'>p</span> <span class='hs-varid'>elt_ty</span><span class='hs-layout'>)</span>
<a name="line-147"></a>				     <span class='hs-varid'>pats</span> <span class='hs-varid'>penv</span> <span class='hs-varid'>thing_inside</span>
<a name="line-148"></a> 	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkHsWrapPat</span> <span class='hs-varid'>coi</span> <span class='hs-layout'>(</span><span class='hs-conid'>ListPat</span> <span class='hs-varid'>pats'</span> <span class='hs-varid'>elt_ty</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span> <span class='hs-varid'>pat_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> 
<a name="line-149"></a>        <span class='hs-layout'>}</span>
<a name="line-150"></a>
<a name="line-151"></a><span class='hs-definition'>tc_pat</span> <span class='hs-varid'>penv</span> <span class='hs-layout'>(</span><span class='hs-conid'>ListPat</span> <span class='hs-varid'>pats</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>e</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>pat_ty</span> <span class='hs-varid'>thing_inside</span>
<a name="line-152"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>list_pat_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-153"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>e'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSyntaxOp</span> <span class='hs-conid'>ListOrigin</span> <span class='hs-varid'>e</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFunTy</span> <span class='hs-varid'>pat_ty</span> <span class='hs-varid'>list_pat_ty</span><span class='hs-layout'>)</span>
<a name="line-154"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>coi</span><span class='hs-layout'>,</span> <span class='hs-varid'>elt_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>matchExpectedPatTy</span> <span class='hs-varid'>matchExpectedListTy</span> <span class='hs-varid'>list_pat_ty</span>
<a name="line-155"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>pats'</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMultiple</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>p</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tc_lpat</span> <span class='hs-varid'>p</span> <span class='hs-varid'>elt_ty</span><span class='hs-layout'>)</span>
<a name="line-156"></a>				     <span class='hs-varid'>pats</span> <span class='hs-varid'>penv</span> <span class='hs-varid'>thing_inside</span>
<a name="line-157"></a> 	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkHsWrapPat</span> <span class='hs-varid'>coi</span> <span class='hs-layout'>(</span><span class='hs-conid'>ListPat</span> <span class='hs-varid'>pats'</span> <span class='hs-varid'>elt_ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>pat_ty</span><span class='hs-layout'>,</span><span class='hs-varid'>e'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>list_pat_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> 
<a name="line-158"></a>        <span class='hs-layout'>}</span>
<a name="line-159"></a>
<a name="line-160"></a><span class='hs-definition'>tc_pat</span> <span class='hs-varid'>penv</span> <span class='hs-layout'>(</span><span class='hs-conid'>PArrPat</span> <span class='hs-varid'>pats</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>pat_ty</span> <span class='hs-varid'>thing_inside</span>
<a name="line-161"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>coi</span><span class='hs-layout'>,</span> <span class='hs-varid'>elt_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>matchExpectedPatTy</span> <span class='hs-varid'>matchExpectedPArrTy</span> <span class='hs-varid'>pat_ty</span>
<a name="line-162"></a>	<span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>pats'</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMultiple</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>p</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tc_lpat</span> <span class='hs-varid'>p</span> <span class='hs-varid'>elt_ty</span><span class='hs-layout'>)</span>
<a name="line-163"></a>				     <span class='hs-varid'>pats</span> <span class='hs-varid'>penv</span> <span class='hs-varid'>thing_inside</span> 
<a name="line-164"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkHsWrapPat</span> <span class='hs-varid'>coi</span> <span class='hs-layout'>(</span><span class='hs-conid'>PArrPat</span> <span class='hs-varid'>pats'</span> <span class='hs-varid'>elt_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>pat_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-165"></a>        <span class='hs-layout'>}</span>
<a name="line-166"></a>
<a name="line-167"></a><span class='hs-definition'>tc_pat</span> <span class='hs-varid'>penv</span> <span class='hs-layout'>(</span><span class='hs-conid'>TuplePat</span> <span class='hs-varid'>pats</span> <span class='hs-varid'>boxity</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>pat_ty</span> <span class='hs-varid'>thing_inside</span>
<a name="line-168"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tupleTyCon</span> <span class='hs-layout'>(</span><span class='hs-varid'>boxityNormalTupleSort</span> <span class='hs-varid'>boxity</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>pats</span><span class='hs-layout'>)</span>
<a name="line-169"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>coi</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>matchExpectedPatTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>matchExpectedTyConApp</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>pat_ty</span>
<a name="line-170"></a>	<span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>pats'</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lpats</span> <span class='hs-varid'>penv</span> <span class='hs-varid'>pats</span> <span class='hs-varid'>arg_tys</span> <span class='hs-varid'>thing_inside</span>
<a name="line-171"></a>
<a name="line-172"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-173"></a>
<a name="line-174"></a>	<span class='hs-comment'>-- Under flag control turn a pattern (x,y,z) into ~(x,y,z)</span>
<a name="line-175"></a>	<span class='hs-comment'>-- so that we can experiment with lazy tuple-matching.</span>
<a name="line-176"></a>	<span class='hs-comment'>-- This is a pretty odd place to make the switch, but</span>
<a name="line-177"></a>	<span class='hs-comment'>-- it was easy to do.</span>
<a name="line-178"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> 
<a name="line-179"></a>              <span class='hs-varid'>unmangled_result</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TuplePat</span> <span class='hs-varid'>pats'</span> <span class='hs-varid'>boxity</span> <span class='hs-varid'>arg_tys</span>
<a name="line-180"></a>                                 <span class='hs-comment'>-- pat_ty /= pat_ty iff coi /= IdCo</span>
<a name="line-181"></a>	      <span class='hs-varid'>possibly_mangled_result</span>
<a name="line-182"></a>	        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_IrrefutableTuples</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-183"></a>                  <span class='hs-varid'>isBoxed</span> <span class='hs-varid'>boxity</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LazyPat</span> <span class='hs-layout'>(</span><span class='hs-varid'>noLoc</span> <span class='hs-varid'>unmangled_result</span><span class='hs-layout'>)</span>
<a name="line-184"></a>	        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>		    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unmangled_result</span>
<a name="line-185"></a>
<a name="line-186"></a> 	<span class='hs-layout'>;</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>length</span> <span class='hs-varid'>arg_tys</span> <span class='hs-varop'>==</span> <span class='hs-varid'>length</span> <span class='hs-varid'>pats</span> <span class='hs-layout'>)</span>      <span class='hs-comment'>-- Syntactically enforced</span>
<a name="line-187"></a>	  <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkHsWrapPat</span> <span class='hs-varid'>coi</span> <span class='hs-varid'>possibly_mangled_result</span> <span class='hs-varid'>pat_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-188"></a>        <span class='hs-layout'>}</span>
<a name="line-189"></a>
<a name="line-190"></a><span class='hs-comment'>------------------------</span>
<a name="line-191"></a><span class='hs-comment'>-- Data constructors</span>
<a name="line-192"></a><span class='hs-definition'>tc_pat</span> <span class='hs-varid'>penv</span> <span class='hs-layout'>(</span><span class='hs-conid'>ConPatIn</span> <span class='hs-varid'>con</span> <span class='hs-varid'>arg_pats</span><span class='hs-layout'>)</span> <span class='hs-varid'>pat_ty</span> <span class='hs-varid'>thing_inside</span>
<a name="line-193"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcConPat</span> <span class='hs-varid'>penv</span> <span class='hs-varid'>con</span> <span class='hs-varid'>pat_ty</span> <span class='hs-varid'>arg_pats</span> <span class='hs-varid'>thing_inside</span>
<a name="line-194"></a>
<a name="line-195"></a><span class='hs-comment'>------------------------</span>
<a name="line-196"></a><span class='hs-comment'>-- Literal patterns</span>
<a name="line-197"></a><span class='hs-definition'>tc_pat</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitPat</span> <span class='hs-varid'>simple_lit</span><span class='hs-layout'>)</span> <span class='hs-varid'>pat_ty</span> <span class='hs-varid'>thing_inside</span>
<a name="line-198"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>lit_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsLitType</span> <span class='hs-varid'>simple_lit</span>
<a name="line-199"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unifyPatType</span> <span class='hs-varid'>lit_ty</span> <span class='hs-varid'>pat_ty</span>
<a name="line-200"></a>		<span class='hs-comment'>-- coi is of kind: pat_ty ~ lit_ty</span>
<a name="line-201"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span> 
<a name="line-202"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-varid'>mkHsWrapPatCo</span> <span class='hs-varid'>co</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitPat</span> <span class='hs-varid'>simple_lit</span><span class='hs-layout'>)</span> <span class='hs-varid'>pat_ty</span> 
<a name="line-203"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-204"></a>
<a name="line-205"></a><span class='hs-comment'>------------------------</span>
<a name="line-206"></a><span class='hs-comment'>-- Overloaded patterns: n, and n+k</span>
<a name="line-207"></a><span class='hs-definition'>tc_pat</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>NPat</span> <span class='hs-varid'>over_lit</span> <span class='hs-varid'>mb_neg</span> <span class='hs-varid'>eq</span><span class='hs-layout'>)</span> <span class='hs-varid'>pat_ty</span> <span class='hs-varid'>thing_inside</span>
<a name="line-208"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>orig</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LiteralOrigin</span> <span class='hs-varid'>over_lit</span>
<a name="line-209"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>lit'</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newOverloadedLit</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>over_lit</span> <span class='hs-varid'>pat_ty</span>
<a name="line-210"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>eq'</span>     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSyntaxOp</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>eq</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFunTys</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>pat_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>pat_ty</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>boolTy</span><span class='hs-layout'>)</span>
<a name="line-211"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>mb_neg'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_neg</span> <span class='hs-keyword'>of</span>
<a name="line-212"></a>			<span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>	<span class='hs-comment'>-- Positive literal</span>
<a name="line-213"></a>			<span class='hs-conid'>Just</span> <span class='hs-varid'>neg</span> <span class='hs-keyglyph'>-&gt;</span> 	<span class='hs-comment'>-- Negative literal</span>
<a name="line-214"></a>					<span class='hs-comment'>-- The 'negate' is re-mappable syntax</span>
<a name="line-215"></a> 			    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>neg'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSyntaxOp</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>neg</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFunTy</span> <span class='hs-varid'>pat_ty</span> <span class='hs-varid'>pat_ty</span><span class='hs-layout'>)</span>
<a name="line-216"></a>			       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>neg'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-217"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span> 
<a name="line-218"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>NPat</span> <span class='hs-varid'>lit'</span> <span class='hs-varid'>mb_neg'</span> <span class='hs-varid'>eq'</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-219"></a>
<a name="line-220"></a><span class='hs-definition'>tc_pat</span> <span class='hs-varid'>penv</span> <span class='hs-layout'>(</span><span class='hs-conid'>NPlusKPat</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>nm_loc</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varid'>lit</span> <span class='hs-varid'>ge</span> <span class='hs-varid'>minus</span><span class='hs-layout'>)</span> <span class='hs-varid'>pat_ty</span> <span class='hs-varid'>thing_inside</span>
<a name="line-221"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndr_id</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>nm_loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcPatBndr</span> <span class='hs-varid'>penv</span> <span class='hs-varid'>name</span> <span class='hs-varid'>pat_ty</span><span class='hs-layout'>)</span>
<a name="line-222"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>pat_ty'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idType</span> <span class='hs-varid'>bndr_id</span>
<a name="line-223"></a>	      <span class='hs-varid'>orig</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LiteralOrigin</span> <span class='hs-varid'>lit</span>
<a name="line-224"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>lit'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newOverloadedLit</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>lit</span> <span class='hs-varid'>pat_ty'</span>
<a name="line-225"></a>
<a name="line-226"></a>	<span class='hs-comment'>-- The '&gt;=' and '-' parts are re-mappable syntax</span>
<a name="line-227"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>ge'</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSyntaxOp</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>ge</span>    <span class='hs-layout'>(</span><span class='hs-varid'>mkFunTys</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>pat_ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>pat_ty'</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>boolTy</span><span class='hs-layout'>)</span>
<a name="line-228"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>minus'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSyntaxOp</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>minus</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFunTys</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>pat_ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>pat_ty'</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>pat_ty'</span><span class='hs-layout'>)</span>
<a name="line-229"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>pat'</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NPlusKPat</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>nm_loc</span> <span class='hs-varid'>bndr_id</span><span class='hs-layout'>)</span> <span class='hs-varid'>lit'</span> <span class='hs-varid'>ge'</span> <span class='hs-varid'>minus'</span>
<a name="line-230"></a>
<a name="line-231"></a>	<span class='hs-comment'>-- The Report says that n+k patterns must be in Integral</span>
<a name="line-232"></a>	<span class='hs-comment'>-- We may not want this when using re-mappable syntax, though (ToDo?)</span>
<a name="line-233"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>icls</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupClass</span> <span class='hs-varid'>integralClassName</span>
<a name="line-234"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>instStupidTheta</span> <span class='hs-varid'>orig</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>mkClassPred</span> <span class='hs-varid'>icls</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>pat_ty'</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>	
<a name="line-235"></a>    
<a name="line-236"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcExtendIdEnv1</span> <span class='hs-varid'>name</span> <span class='hs-varid'>bndr_id</span> <span class='hs-varid'>thing_inside</span>
<a name="line-237"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkHsWrapPatCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>pat'</span> <span class='hs-varid'>pat_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-238"></a>
<a name="line-239"></a><span class='hs-definition'>tc_pat</span> <span class='hs-keyword'>_</span> <span class='hs-sel'>_other_pat</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"tc_pat"</span> 	<span class='hs-comment'>-- ConPatOut, SigPatOut</span>
<a name="line-240"></a>
<a name="line-241"></a><a name="unifyPatType"></a><span class='hs-comment'>----------------</span>
<a name="line-242"></a><span class='hs-definition'>unifyPatType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-243"></a><span class='hs-comment'>-- In patterns we want a coercion from the</span>
<a name="line-244"></a><span class='hs-comment'>-- context type (expected) to the actual pattern type</span>
<a name="line-245"></a><span class='hs-comment'>-- But we don't want to reverse the args to unifyType because</span>
<a name="line-246"></a><span class='hs-comment'>-- that controls the actual/expected stuff in error messages</span>
<a name="line-247"></a><span class='hs-definition'>unifyPatType</span> <span class='hs-varid'>actual_ty</span> <span class='hs-varid'>expected_ty</span>
<a name="line-248"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>coi</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unifyType</span> <span class='hs-varid'>actual_ty</span> <span class='hs-varid'>expected_ty</span>
<a name="line-249"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcSymCo</span> <span class='hs-varid'>coi</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre>\end{code}

Note [Hopping the LIE in lazy patterns]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In a lazy pattern, we must *not* discharge constraints from the RHS
from dictionaries bound in the pattern.  E.g.
	f ~(C x) = 3
We can't discharge the Num constraint from dictionaries bound by
the pattern C!  

So we have to make the constraints from thing_inside "hop around" 
the pattern.  Hence the captureConstraints and emitConstraints.

The same thing ensures that equality constraints in a lazy match
are not made available in the RHS of the match. For example
	data T a where { T1 :: Int -> T Int; ... }
	f :: T a -> Int -> a
	f ~(T1 i) y = y
It's obviously not sound to refine a to Int in the right
hand side, because the arugment might not match T1 at all!

Finally, a lazy pattern should not bind any existential type variables
because they won't be in scope when we do the desugaring


%************************************************************************
%*									*
	Most of the work for constructors is here
	(the rest is in the ConPatIn case of tc_pat)
%*									*
%************************************************************************

[Pattern matching indexed data types]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider the following declarations:

  data family Map k :: * -> *
  data instance Map (a, b) v = MapPair (Map a (Pair b v))

and a case expression

  case x :: Map (Int, c) w of MapPair m -> ...

As explained by [Wrappers for data instance tycons] in MkIds.lhs, the
worker/wrapper types for MapPair are

  $WMapPair :: forall a b v. Map a (Map a b v) -> Map (a, b) v
  $wMapPair :: forall a b v. Map a (Map a b v) -> :R123Map a b v

So, the type of the scrutinee is Map (Int, c) w, but the tycon of MapPair is
:R123Map, which means the straight use of boxySplitTyConApp would give a type
error.  Hence, the smart wrapper function boxySplitTyConAppWithFamily calls
boxySplitTyConApp with the family tycon Map instead, which gives us the family
type list {(Int, c), w}.  To get the correct split for :R123Map, we need to
unify the family type list {(Int, c), w} with the instance types {(a, b), v}
(provided by tyConFamInst_maybe together with the family tycon).  This
unification yields the substitution [a -> Int, b -> c, v -> w], which gives us
the split arguments for the representation tycon :R123Map as {Int, c, w}

In other words, boxySplitTyConAppWithFamily implicitly takes the coercion 

  Co123Map a b v :: {Map (a, b) v ~ :R123Map a b v}

moving between representation and family type into account.  To produce type
correct Core, this coercion needs to be used to case the type of the scrutinee
from the family to the representation type.  This is achieved by
unwrapFamInstScrutinee using a CoPat around the result pattern.

Now it might appear seem as if we could have used the previous GADT type
refinement infrastructure of refineAlt and friends instead of the explicit
unification and CoPat generation.  However, that would be wrong.  Why?  The
whole point of GADT refinement is that the refinement is local to the case
alternative.  In contrast, the substitution generated by the unification of
the family type list and instance types needs to be propagated to the outside.
Imagine that in the above example, the type of the scrutinee would have been
(Map x w), then we would have unified {x, w} with {(a, b), v}, yielding the
substitution [x -> (a, b), v -> w].  In contrast to GADT matching, the
instantiation of x with (a, b) must be global; ie, it must be valid in *all*
alternatives of the case expression, whereas in the GADT case it might vary
between alternatives.

RIP GADT refinement: refinements have been replaced by the use of explicit
equality constraints that are used in conjunction with implication constraints
to express the local scope of GADT refinements.

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>--	Running example:</span>
<a name="line-2"></a><span class='hs-comment'>-- MkT :: forall a b c. (a~[b]) =&gt; b -&gt; c -&gt; T a</span>
<a name="line-3"></a><span class='hs-comment'>-- 	 with scrutinee of type (T ty)</span>
<a name="line-4"></a>
<a name="line-5"></a><a name="tcConPat"></a><span class='hs-definition'>tcConPat</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PatEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Located</span> <span class='hs-conid'>Name</span> 
<a name="line-6"></a>	 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRhoType</span>  	       	<span class='hs-comment'>-- Type of the pattern</span>
<a name="line-7"></a>	 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsConPatDetails</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-8"></a>	 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Pat</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-9"></a><span class='hs-definition'>tcConPat</span> <span class='hs-varid'>penv</span> <span class='hs-varid'>con_lname</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>con_name</span><span class='hs-layout'>)</span> <span class='hs-varid'>pat_ty</span> <span class='hs-varid'>arg_pats</span> <span class='hs-varid'>thing_inside</span>
<a name="line-10"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>con_like</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupConLike</span> <span class='hs-varid'>con_name</span>
<a name="line-11"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>con_like</span> <span class='hs-keyword'>of</span>
<a name="line-12"></a>            <span class='hs-conid'>RealDataCon</span> <span class='hs-varid'>data_con</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tcDataConPat</span> <span class='hs-varid'>penv</span> <span class='hs-varid'>con_lname</span> <span class='hs-varid'>data_con</span>
<a name="line-13"></a>                                                 <span class='hs-varid'>pat_ty</span> <span class='hs-varid'>arg_pats</span> <span class='hs-varid'>thing_inside</span>
<a name="line-14"></a>            <span class='hs-conid'>PatSynCon</span> <span class='hs-varid'>pat_syn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tcPatSynPat</span> <span class='hs-varid'>penv</span> <span class='hs-varid'>con_lname</span> <span class='hs-varid'>pat_syn</span>
<a name="line-15"></a>                                             <span class='hs-varid'>pat_ty</span> <span class='hs-varid'>arg_pats</span> <span class='hs-varid'>thing_inside</span>
<a name="line-16"></a>        <span class='hs-layout'>}</span>
<a name="line-17"></a>
<a name="line-18"></a><a name="tcDataConPat"></a><span class='hs-definition'>tcDataConPat</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PatEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Located</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DataCon</span>
<a name="line-19"></a>	     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRhoType</span>  	       	<span class='hs-comment'>-- Type of the pattern</span>
<a name="line-20"></a>	     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsConPatDetails</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-21"></a>	     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Pat</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-22"></a><span class='hs-definition'>tcDataConPat</span> <span class='hs-varid'>penv</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>con_span</span> <span class='hs-varid'>con_name</span><span class='hs-layout'>)</span> <span class='hs-varid'>data_con</span> <span class='hs-varid'>pat_ty</span> <span class='hs-varid'>arg_pats</span> <span class='hs-varid'>thing_inside</span>
<a name="line-23"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tycon</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConTyCon</span> <span class='hs-varid'>data_con</span>
<a name="line-24"></a>         	  <span class='hs-comment'>-- For data families this is the representation tycon</span>
<a name="line-25"></a>	      <span class='hs-layout'>(</span><span class='hs-varid'>univ_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ex_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>eq_spec</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-26"></a>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConFullSig</span> <span class='hs-varid'>data_con</span>
<a name="line-27"></a>              <span class='hs-varid'>header</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>con_span</span> <span class='hs-layout'>(</span><span class='hs-conid'>RealDataCon</span> <span class='hs-varid'>data_con</span><span class='hs-layout'>)</span>
<a name="line-28"></a>
<a name="line-29"></a>	  <span class='hs-comment'>-- Instantiate the constructor type variables [a-&gt;ty]</span>
<a name="line-30"></a>	  <span class='hs-comment'>-- This may involve doing a family-instance coercion, </span>
<a name="line-31"></a>	  <span class='hs-comment'>-- and building a wrapper </span>
<a name="line-32"></a>	<span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrap</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctxt_res_tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>matchExpectedPatTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>matchExpectedConTy</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>)</span> <span class='hs-varid'>pat_ty</span>
<a name="line-33"></a>
<a name="line-34"></a>	  <span class='hs-comment'>-- Add the stupid theta</span>
<a name="line-35"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>con_span</span> <span class='hs-varop'>$</span> <span class='hs-varid'>addDataConStupidTheta</span> <span class='hs-varid'>data_con</span> <span class='hs-varid'>ctxt_res_tys</span>
<a name="line-36"></a>
<a name="line-37"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>checkExistentials</span> <span class='hs-varid'>ex_tvs</span> <span class='hs-varid'>penv</span> 
<a name="line-38"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tenv</span><span class='hs-layout'>,</span> <span class='hs-varid'>ex_tvs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInstSuperSkolTyVarsX</span>
<a name="line-39"></a>                               <span class='hs-layout'>(</span><span class='hs-varid'>zipTopTvSubst</span> <span class='hs-varid'>univ_tvs</span> <span class='hs-varid'>ctxt_res_tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>ex_tvs</span>
<a name="line-40"></a>                     <span class='hs-comment'>-- Get location from monad, not from ex_tvs</span>
<a name="line-41"></a>
<a name="line-42"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-comment'>-- pat_ty' = mkTyConApp tycon ctxt_res_tys</span>
<a name="line-43"></a>	      <span class='hs-comment'>-- pat_ty' is type of the actual constructor application</span>
<a name="line-44"></a>              <span class='hs-comment'>-- pat_ty' /= pat_ty iff coi /= IdCo</span>
<a name="line-45"></a>
<a name="line-46"></a>	      <span class='hs-varid'>arg_tys'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTys</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>arg_tys</span>
<a name="line-47"></a>
<a name="line-48"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcConPat"</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>con_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>univ_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ex_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>eq_spec</span>
<a name="line-49"></a>                                   <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ex_tvs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ctxt_res_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>arg_tys'</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-50"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>null</span> <span class='hs-varid'>ex_tvs</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>null</span> <span class='hs-varid'>eq_spec</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>null</span> <span class='hs-varid'>theta</span>
<a name="line-51"></a>	  <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-comment'>-- The common case; no class bindings etc </span>
<a name="line-52"></a>                    <span class='hs-comment'>-- (see Note [Arrows and patterns])</span>
<a name="line-53"></a>		    <span class='hs-layout'>(</span><span class='hs-varid'>arg_pats'</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcConArgs</span> <span class='hs-layout'>(</span><span class='hs-conid'>RealDataCon</span> <span class='hs-varid'>data_con</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg_tys'</span>
<a name="line-54"></a>						  <span class='hs-varid'>arg_pats</span> <span class='hs-varid'>penv</span> <span class='hs-varid'>thing_inside</span>
<a name="line-55"></a>		  <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>res_pat</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ConPatOut</span> <span class='hs-layout'>{</span> <span class='hs-varid'>pat_con</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>header</span><span class='hs-layout'>,</span>
<a name="line-56"></a>			            	      <span class='hs-varid'>pat_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>pat_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> 
<a name="line-57"></a>                                              <span class='hs-varid'>pat_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyTcEvBinds</span><span class='hs-layout'>,</span>
<a name="line-58"></a>					      <span class='hs-varid'>pat_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arg_pats'</span><span class='hs-layout'>,</span> 
<a name="line-59"></a>                                              <span class='hs-varid'>pat_arg_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctxt_res_tys</span><span class='hs-layout'>,</span>
<a name="line-60"></a>                                              <span class='hs-varid'>pat_wrap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idHsWrapper</span> <span class='hs-layout'>}</span>
<a name="line-61"></a>
<a name="line-62"></a>		  <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkHsWrapPat</span> <span class='hs-varid'>wrap</span> <span class='hs-varid'>res_pat</span> <span class='hs-varid'>pat_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-63"></a>
<a name="line-64"></a>	  <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span>   <span class='hs-comment'>-- The general case, with existential, </span>
<a name="line-65"></a>                    <span class='hs-comment'>-- and local equality constraints</span>
<a name="line-66"></a>	<span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>theta'</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTheta</span> <span class='hs-varid'>tenv</span> <span class='hs-layout'>(</span><span class='hs-varid'>eqSpecPreds</span> <span class='hs-varid'>eq_spec</span> <span class='hs-varop'>++</span> <span class='hs-varid'>theta</span><span class='hs-layout'>)</span>
<a name="line-67"></a>                           <span class='hs-comment'>-- order is *important* as we generate the list of</span>
<a name="line-68"></a>                           <span class='hs-comment'>-- dictionary binders from theta'</span>
<a name="line-69"></a>	      <span class='hs-varid'>no_equalities</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>any</span> <span class='hs-varid'>isEqPred</span> <span class='hs-varid'>theta'</span><span class='hs-layout'>)</span>
<a name="line-70"></a>              <span class='hs-varid'>skol_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>pe_ctxt</span> <span class='hs-varid'>penv</span> <span class='hs-keyword'>of</span>
<a name="line-71"></a>                            <span class='hs-conid'>LamPat</span> <span class='hs-varid'>mc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PatSkol</span> <span class='hs-layout'>(</span><span class='hs-conid'>RealDataCon</span> <span class='hs-varid'>data_con</span><span class='hs-layout'>)</span> <span class='hs-varid'>mc</span>
<a name="line-72"></a>                            <span class='hs-conid'>LetPat</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UnkSkol</span> <span class='hs-comment'>-- Doesn't matter</span>
<a name="line-73"></a> 
<a name="line-74"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>gadts_on</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_GADTs</span>
<a name="line-75"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>families_on</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_TypeFamilies</span>
<a name="line-76"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>no_equalities</span> <span class='hs-varop'>||</span> <span class='hs-varid'>gadts_on</span> <span class='hs-varop'>||</span> <span class='hs-varid'>families_on</span><span class='hs-layout'>)</span>
<a name="line-77"></a>		  <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"A pattern match on a GADT requires GADTs or TypeFamilies"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-78"></a>		  <span class='hs-comment'>-- Trac #2905 decided that a *pattern-match* of a GADT</span>
<a name="line-79"></a>		  <span class='hs-comment'>-- should require the GADT language flag.  </span>
<a name="line-80"></a>                  <span class='hs-comment'>-- Re TypeFamilies see also #7156 </span>
<a name="line-81"></a>
<a name="line-82"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>given</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newEvVars</span> <span class='hs-varid'>theta'</span>
<a name="line-83"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev_binds</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_pats'</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-84"></a>	     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkConstraints</span> <span class='hs-varid'>skol_info</span> <span class='hs-varid'>ex_tvs'</span> <span class='hs-varid'>given</span> <span class='hs-varop'>$</span>
<a name="line-85"></a>                <span class='hs-varid'>tcConArgs</span> <span class='hs-layout'>(</span><span class='hs-conid'>RealDataCon</span> <span class='hs-varid'>data_con</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg_tys'</span> <span class='hs-varid'>arg_pats</span> <span class='hs-varid'>penv</span> <span class='hs-varid'>thing_inside</span>
<a name="line-86"></a>
<a name="line-87"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>res_pat</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ConPatOut</span> <span class='hs-layout'>{</span> <span class='hs-varid'>pat_con</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>header</span><span class='hs-layout'>,</span>
<a name="line-88"></a>			            <span class='hs-varid'>pat_tvs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ex_tvs'</span><span class='hs-layout'>,</span>
<a name="line-89"></a>			            <span class='hs-varid'>pat_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>given</span><span class='hs-layout'>,</span>
<a name="line-90"></a>			            <span class='hs-varid'>pat_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev_binds</span><span class='hs-layout'>,</span>
<a name="line-91"></a>			            <span class='hs-varid'>pat_args</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arg_pats'</span><span class='hs-layout'>,</span> 
<a name="line-92"></a>                                    <span class='hs-varid'>pat_arg_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctxt_res_tys</span><span class='hs-layout'>,</span>
<a name="line-93"></a>                                    <span class='hs-varid'>pat_wrap</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idHsWrapper</span> <span class='hs-layout'>}</span>
<a name="line-94"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkHsWrapPat</span> <span class='hs-varid'>wrap</span> <span class='hs-varid'>res_pat</span> <span class='hs-varid'>pat_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-95"></a>	<span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-96"></a>
<a name="line-97"></a><a name="tcPatSynPat"></a><span class='hs-definition'>tcPatSynPat</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PatEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Located</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PatSyn</span>
<a name="line-98"></a>	    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRhoType</span>  	       	<span class='hs-comment'>-- Type of the pattern</span>
<a name="line-99"></a>	    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsConPatDetails</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-100"></a>	    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Pat</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-101"></a><span class='hs-definition'>tcPatSynPat</span> <span class='hs-varid'>penv</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>con_span</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>pat_syn</span> <span class='hs-varid'>pat_ty</span> <span class='hs-varid'>arg_pats</span> <span class='hs-varid'>thing_inside</span>
<a name="line-102"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>univ_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ex_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>prov_theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>req_theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>patSynSig</span> <span class='hs-varid'>pat_syn</span>
<a name="line-103"></a>
<a name="line-104"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>univ_tvs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>inst_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInstTyVars</span> <span class='hs-varid'>univ_tvs</span>
<a name="line-105"></a>
<a name="line-106"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>checkExistentials</span> <span class='hs-varid'>ex_tvs</span> <span class='hs-varid'>penv</span>
<a name="line-107"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tenv</span><span class='hs-layout'>,</span> <span class='hs-varid'>ex_tvs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInstSuperSkolTyVarsX</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ex_tvs</span>
<a name="line-108"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTy</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>ty</span>
<a name="line-109"></a>              <span class='hs-varid'>arg_tys'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTys</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>arg_tys</span>
<a name="line-110"></a>              <span class='hs-varid'>prov_theta'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTheta</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>prov_theta</span>
<a name="line-111"></a>              <span class='hs-varid'>req_theta'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTheta</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>req_theta</span>
<a name="line-112"></a>
<a name="line-113"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>wrap</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coToHsWrapper</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>unifyType</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>pat_ty</span>
<a name="line-114"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcPatSynPat"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>pat_syn</span> <span class='hs-varop'>$$</span>
<a name="line-115"></a>                                 <span class='hs-varid'>ppr</span> <span class='hs-varid'>pat_ty</span> <span class='hs-varop'>$$</span>
<a name="line-116"></a>                                 <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty'</span> <span class='hs-varop'>$$</span>
<a name="line-117"></a>                                 <span class='hs-varid'>ppr</span> <span class='hs-varid'>ex_tvs'</span> <span class='hs-varop'>$$</span>
<a name="line-118"></a>                                 <span class='hs-varid'>ppr</span> <span class='hs-varid'>prov_theta'</span> <span class='hs-varop'>$$</span>
<a name="line-119"></a>                                 <span class='hs-varid'>ppr</span> <span class='hs-varid'>req_theta'</span> <span class='hs-varop'>$$</span>
<a name="line-120"></a>                                 <span class='hs-varid'>ppr</span> <span class='hs-varid'>arg_tys'</span><span class='hs-layout'>)</span>
<a name="line-121"></a>
<a name="line-122"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>prov_dicts'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newEvVars</span> <span class='hs-varid'>prov_theta'</span>
<a name="line-123"></a>
<a name="line-124"></a>        <span class='hs-comment'>-- Using a pattern synonym requires the PatternSynonyms</span>
<a name="line-125"></a>        <span class='hs-comment'>-- language flag to keep consistent with #2905</span>
<a name="line-126"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>patsyns_on</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_PatternSynonyms</span>
<a name="line-127"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-varid'>patsyns_on</span>
<a name="line-128"></a>                  <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"A pattern match on a pattern synonym requires PatternSynonyms"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-129"></a>
<a name="line-130"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>skol_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>pe_ctxt</span> <span class='hs-varid'>penv</span> <span class='hs-keyword'>of</span>
<a name="line-131"></a>                            <span class='hs-conid'>LamPat</span> <span class='hs-varid'>mc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PatSkol</span> <span class='hs-layout'>(</span><span class='hs-conid'>PatSynCon</span> <span class='hs-varid'>pat_syn</span><span class='hs-layout'>)</span> <span class='hs-varid'>mc</span>
<a name="line-132"></a>                            <span class='hs-conid'>LetPat</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UnkSkol</span> <span class='hs-comment'>-- Doesn't matter</span>
<a name="line-133"></a>
<a name="line-134"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>req_wrap</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>instCall</span> <span class='hs-conid'>PatOrigin</span> <span class='hs-varid'>inst_tys</span> <span class='hs-varid'>req_theta'</span>
<a name="line-135"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"instCall"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>req_wrap</span><span class='hs-layout'>)</span>
<a name="line-136"></a>
<a name="line-137"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"checkConstraints {"</span> <span class='hs-varid'>empty</span>
<a name="line-138"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev_binds</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_pats'</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-139"></a>             <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkConstraints</span> <span class='hs-varid'>skol_info</span> <span class='hs-varid'>ex_tvs'</span> <span class='hs-varid'>prov_dicts'</span> <span class='hs-varop'>$</span>
<a name="line-140"></a>                <span class='hs-varid'>tcConArgs</span> <span class='hs-layout'>(</span><span class='hs-conid'>PatSynCon</span> <span class='hs-varid'>pat_syn</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg_tys'</span> <span class='hs-varid'>arg_pats</span> <span class='hs-varid'>penv</span> <span class='hs-varid'>thing_inside</span>
<a name="line-141"></a>
<a name="line-142"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"checkConstraints }"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ev_binds</span><span class='hs-layout'>)</span>
<a name="line-143"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>res_pat</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ConPatOut</span> <span class='hs-layout'>{</span> <span class='hs-varid'>pat_con</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>con_span</span> <span class='hs-varop'>$</span> <span class='hs-conid'>PatSynCon</span> <span class='hs-varid'>pat_syn</span><span class='hs-layout'>,</span>
<a name="line-144"></a>			            <span class='hs-varid'>pat_tvs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ex_tvs'</span><span class='hs-layout'>,</span>
<a name="line-145"></a>			            <span class='hs-varid'>pat_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>prov_dicts'</span><span class='hs-layout'>,</span>
<a name="line-146"></a>			            <span class='hs-varid'>pat_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev_binds</span><span class='hs-layout'>,</span>
<a name="line-147"></a>			            <span class='hs-varid'>pat_args</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arg_pats'</span><span class='hs-layout'>,</span>
<a name="line-148"></a>                                    <span class='hs-varid'>pat_arg_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVarTys</span> <span class='hs-varid'>univ_tvs'</span><span class='hs-layout'>,</span>
<a name="line-149"></a>                                    <span class='hs-varid'>pat_wrap</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>req_wrap</span> <span class='hs-layout'>}</span>
<a name="line-150"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkHsWrapPat</span> <span class='hs-varid'>wrap</span> <span class='hs-varid'>res_pat</span> <span class='hs-varid'>pat_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-151"></a>
<a name="line-152"></a><a name="matchExpectedPatTy"></a><span class='hs-comment'>----------------------------</span>
<a name="line-153"></a><span class='hs-definition'>matchExpectedPatTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcRhoType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCoercion</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-154"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRhoType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWrapper</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> 
<a name="line-155"></a><span class='hs-comment'>-- See Note [Matching polytyped patterns]</span>
<a name="line-156"></a><span class='hs-comment'>-- Returns a wrapper : pat_ty ~ inner_ty</span>
<a name="line-157"></a><span class='hs-definition'>matchExpectedPatTy</span> <span class='hs-varid'>inner_match</span> <span class='hs-varid'>pat_ty</span>
<a name="line-158"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>null</span> <span class='hs-varid'>theta</span>
<a name="line-159"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>inner_match</span> <span class='hs-varid'>pat_ty</span>
<a name="line-160"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>coToHsWrapper</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcSymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-161"></a>       	 <span class='hs-comment'>-- The Sym is because the inner_match returns a coercion</span>
<a name="line-162"></a>	 <span class='hs-comment'>-- that is the other way round to matchExpectedPatTy</span>
<a name="line-163"></a>
<a name="line-164"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-165"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInstTyVars</span> <span class='hs-varid'>tvs</span>
<a name="line-166"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wrap1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>instCall</span> <span class='hs-conid'>PatOrigin</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTheta</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>theta</span><span class='hs-layout'>)</span>
<a name="line-167"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrap2</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>matchExpectedPatTy</span> <span class='hs-varid'>inner_match</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcType</span><span class='hs-varop'>.</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span>
<a name="line-168"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrap2</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>wrap1</span> <span class='hs-layout'>,</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-169"></a>  <span class='hs-keyword'>where</span>
<a name="line-170"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitSigmaTy</span> <span class='hs-varid'>pat_ty</span>
<a name="line-171"></a>
<a name="line-172"></a><a name="matchExpectedConTy"></a><span class='hs-comment'>----------------------------</span>
<a name="line-173"></a><span class='hs-definition'>matchExpectedConTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span>  	 <span class='hs-comment'>-- The TyCon that this data </span>
<a name="line-174"></a>		    		 <span class='hs-comment'>-- constructor actually returns</span>
<a name="line-175"></a>		   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRhoType</span>  <span class='hs-comment'>-- The type of the pattern</span>
<a name="line-176"></a>		   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCoercion</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcSigmaType</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-177"></a><span class='hs-comment'>-- See Note [Matching constructor patterns]</span>
<a name="line-178"></a><span class='hs-comment'>-- Returns a coercion : T ty1 ... tyn ~ pat_ty</span>
<a name="line-179"></a><span class='hs-comment'>-- This is the same way round as matchExpectedListTy etc</span>
<a name="line-180"></a><span class='hs-comment'>-- but the other way round to matchExpectedPatTy</span>
<a name="line-181"></a><span class='hs-definition'>matchExpectedConTy</span> <span class='hs-varid'>data_tc</span> <span class='hs-varid'>pat_ty</span>
<a name="line-182"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>fam_tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>fam_args</span><span class='hs-layout'>,</span> <span class='hs-varid'>co_tc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tyConFamInstSig_maybe</span> <span class='hs-varid'>data_tc</span>
<a name="line-183"></a>    	 <span class='hs-comment'>-- Comments refer to Note [Matching constructor patterns]</span>
<a name="line-184"></a>     	 <span class='hs-comment'>-- co_tc :: forall a. T [a] ~ T7 a</span>
<a name="line-185"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInstTyVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConTyVars</span> <span class='hs-varid'>data_tc</span><span class='hs-layout'>)</span>
<a name="line-186"></a>       	     <span class='hs-comment'>-- tys = [ty1,ty2]</span>
<a name="line-187"></a>
<a name="line-188"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"matchExpectedConTy"</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>data_tc</span><span class='hs-layout'>,</span> 
<a name="line-189"></a>                                             <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConTyVars</span> <span class='hs-varid'>data_tc</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-190"></a>                                             <span class='hs-varid'>ppr</span> <span class='hs-varid'>fam_tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>fam_args</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-191"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>co1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unifyType</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>fam_tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTys</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>fam_args</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>pat_ty</span>
<a name="line-192"></a>       	     <span class='hs-comment'>-- co1 : T (ty1,ty2) ~ pat_ty</span>
<a name="line-193"></a>
<a name="line-194"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>co2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcUnbranchedAxInstCo</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>co_tc</span> <span class='hs-varid'>tys</span>
<a name="line-195"></a>       	     <span class='hs-comment'>-- co2 : T (ty1,ty2) ~ T7 ty1 ty2</span>
<a name="line-196"></a>
<a name="line-197"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcSymCo</span> <span class='hs-varid'>co2</span> <span class='hs-varop'>`mkTcTransCo`</span> <span class='hs-varid'>co1</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-198"></a>
<a name="line-199"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-200"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>matchExpectedTyConApp</span> <span class='hs-varid'>data_tc</span> <span class='hs-varid'>pat_ty</span>
<a name="line-201"></a>       	     <span class='hs-comment'>-- coi : T tys ~ pat_ty</span>
</pre>\end{code}

Note [Matching constructor patterns]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose (coi, tys) = matchExpectedConType data_tc pat_ty

 * In the simple case, pat_ty = tc tys

 * If pat_ty is a polytype, we want to instantiate it
   This is like part of a subsumption check.  Eg
      f :: (forall a. [a]) -> blah
      f [] = blah

 * In a type family case, suppose we have
          data family T a
          data instance T (p,q) = A p | B q
       Then we'll have internally generated
              data T7 p q = A p | B q
              axiom coT7 p q :: T (p,q) ~ T7 p q
 
       So if pat_ty = T (ty1,ty2), we return (coi, [ty1,ty2]) such that
           coi = coi2 . coi1 : T7 t ~ pat_ty
           coi1 : T (ty1,ty2) ~ pat_ty
           coi2 : T7 ty1 ty2 ~ T (ty1,ty2)

   For families we do all this matching here, not in the unifier,
   because we never want a whisper of the data_tycon to appear in
   error messages; it's a purely internal thing

\begin{code}
<pre><a name="line-1"></a><a name="tcConArgs"></a><span class='hs-definition'>tcConArgs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ConLike</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcSigmaType</span><span class='hs-keyglyph'>]</span>
<a name="line-2"></a>	  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Checker</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsConPatDetails</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsConPatDetails</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span>
<a name="line-3"></a>
<a name="line-4"></a><span class='hs-definition'>tcConArgs</span> <span class='hs-varid'>con_like</span> <span class='hs-varid'>arg_tys</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrefixCon</span> <span class='hs-varid'>arg_pats</span><span class='hs-layout'>)</span> <span class='hs-varid'>penv</span> <span class='hs-varid'>thing_inside</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>con_arity</span> <span class='hs-varop'>==</span> <span class='hs-varid'>no_of_args</span><span class='hs-layout'>)</span>	<span class='hs-comment'>-- Check correct arity</span>
<a name="line-6"></a>		  <span class='hs-layout'>(</span><span class='hs-varid'>arityErr</span> <span class='hs-str'>"Constructor"</span> <span class='hs-varid'>con_like</span> <span class='hs-varid'>con_arity</span> <span class='hs-varid'>no_of_args</span><span class='hs-layout'>)</span>
<a name="line-7"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>pats_w_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipEqual</span> <span class='hs-str'>"tcConArgs"</span> <span class='hs-varid'>arg_pats</span> <span class='hs-varid'>arg_tys</span>
<a name="line-8"></a>	<span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_pats'</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMultiple</span> <span class='hs-varid'>tcConArg</span> <span class='hs-varid'>pats_w_tys</span>
<a name="line-9"></a>					      <span class='hs-varid'>penv</span> <span class='hs-varid'>thing_inside</span> 
<a name="line-10"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrefixCon</span> <span class='hs-varid'>arg_pats'</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-11"></a>  <span class='hs-keyword'>where</span>
<a name="line-12"></a>    <span class='hs-varid'>con_arity</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>conLikeArity</span> <span class='hs-varid'>con_like</span>
<a name="line-13"></a>    <span class='hs-varid'>no_of_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>arg_pats</span>
<a name="line-14"></a>
<a name="line-15"></a><span class='hs-definition'>tcConArgs</span> <span class='hs-varid'>con_like</span> <span class='hs-varid'>arg_tys</span> <span class='hs-layout'>(</span><span class='hs-conid'>InfixCon</span> <span class='hs-varid'>p1</span> <span class='hs-varid'>p2</span><span class='hs-layout'>)</span> <span class='hs-varid'>penv</span> <span class='hs-varid'>thing_inside</span>
<a name="line-16"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>con_arity</span> <span class='hs-varop'>==</span> <span class='hs-num'>2</span><span class='hs-layout'>)</span>	<span class='hs-comment'>-- Check correct arity</span>
<a name="line-17"></a>                  <span class='hs-layout'>(</span><span class='hs-varid'>arityErr</span> <span class='hs-str'>"Constructor"</span> <span class='hs-varid'>con_like</span> <span class='hs-varid'>con_arity</span> <span class='hs-num'>2</span><span class='hs-layout'>)</span>
<a name="line-18"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg_ty1</span><span class='hs-layout'>,</span><span class='hs-varid'>arg_ty2</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arg_tys</span>	<span class='hs-comment'>-- This can't fail after the arity check</span>
<a name="line-19"></a>	<span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>p1'</span><span class='hs-layout'>,</span><span class='hs-varid'>p2'</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMultiple</span> <span class='hs-varid'>tcConArg</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>p1</span><span class='hs-layout'>,</span><span class='hs-varid'>arg_ty1</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-varid'>p2</span><span class='hs-layout'>,</span><span class='hs-varid'>arg_ty2</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-20"></a>					      <span class='hs-varid'>penv</span> <span class='hs-varid'>thing_inside</span>
<a name="line-21"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>InfixCon</span> <span class='hs-varid'>p1'</span> <span class='hs-varid'>p2'</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-22"></a>  <span class='hs-keyword'>where</span>
<a name="line-23"></a>    <span class='hs-varid'>con_arity</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>conLikeArity</span> <span class='hs-varid'>con_like</span>
<a name="line-24"></a>
<a name="line-25"></a><span class='hs-definition'>tcConArgs</span> <span class='hs-varid'>con_like</span> <span class='hs-varid'>arg_tys</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecCon</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsRecFields</span> <span class='hs-varid'>rpats</span> <span class='hs-varid'>dd</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>penv</span> <span class='hs-varid'>thing_inside</span>
<a name="line-26"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>rpats'</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMultiple</span> <span class='hs-varid'>tc_field</span> <span class='hs-varid'>rpats</span> <span class='hs-varid'>penv</span> <span class='hs-varid'>thing_inside</span>
<a name="line-27"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecCon</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsRecFields</span> <span class='hs-varid'>rpats'</span> <span class='hs-varid'>dd</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-28"></a>  <span class='hs-keyword'>where</span>
<a name="line-29"></a>    <span class='hs-varid'>tc_field</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Checker</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsRecField</span> <span class='hs-conid'>FieldLabel</span> <span class='hs-layout'>(</span><span class='hs-conid'>LPat</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsRecField</span> <span class='hs-conid'>TcId</span> <span class='hs-layout'>(</span><span class='hs-conid'>LPat</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-30"></a>    <span class='hs-varid'>tc_field</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsRecField</span> <span class='hs-varid'>field_lbl</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>pun</span><span class='hs-layout'>)</span> <span class='hs-varid'>penv</span> <span class='hs-varid'>thing_inside</span>
<a name="line-31"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>sel_id</span><span class='hs-layout'>,</span> <span class='hs-varid'>pat_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapLocFstM</span> <span class='hs-varid'>find_field_ty</span> <span class='hs-varid'>field_lbl</span>
<a name="line-32"></a>	   <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>pat'</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcConArg</span> <span class='hs-layout'>(</span><span class='hs-varid'>pat</span><span class='hs-layout'>,</span> <span class='hs-varid'>pat_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>penv</span> <span class='hs-varid'>thing_inside</span>
<a name="line-33"></a>	   <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsRecField</span> <span class='hs-varid'>sel_id</span> <span class='hs-varid'>pat'</span> <span class='hs-varid'>pun</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-34"></a>
<a name="line-35"></a>    <span class='hs-varid'>find_field_ty</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FieldLabel</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span>
<a name="line-36"></a>    <span class='hs-varid'>find_field_ty</span> <span class='hs-varid'>field_lbl</span>
<a name="line-37"></a>	<span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span><span class='hs-layout'>,</span><span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>field_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>f</span> <span class='hs-varop'>==</span> <span class='hs-varid'>field_lbl</span><span class='hs-keyglyph'>]</span> <span class='hs-keyword'>of</span>
<a name="line-38"></a>
<a name="line-39"></a>		<span class='hs-comment'>-- No matching field; chances are this field label comes from some</span>
<a name="line-40"></a>		<span class='hs-comment'>-- other record type (or maybe none).  If this happens, just fail,</span>
<a name="line-41"></a>                <span class='hs-comment'>-- otherwise we get crashes later (Trac #8570), and similar:</span>
<a name="line-42"></a>		<span class='hs-comment'>--	f (R { foo = (a,b) }) = a+b</span>
<a name="line-43"></a>		<span class='hs-comment'>-- If foo isn't one of R's fields, we don't want to crash when</span>
<a name="line-44"></a>		<span class='hs-comment'>-- typechecking the "a+b".</span>
<a name="line-45"></a>	   <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failWith</span> <span class='hs-layout'>(</span><span class='hs-varid'>badFieldCon</span> <span class='hs-varid'>con_like</span> <span class='hs-varid'>field_lbl</span><span class='hs-layout'>)</span>
<a name="line-46"></a>
<a name="line-47"></a>		<span class='hs-comment'>-- The normal case, when the field comes from the right constructor</span>
<a name="line-48"></a>	   <span class='hs-layout'>(</span><span class='hs-varid'>pat_ty</span> <span class='hs-conop'>:</span> <span class='hs-varid'>extras</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-49"></a>		<span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>null</span> <span class='hs-varid'>extras</span> <span class='hs-layout'>)</span>
<a name="line-50"></a>		<span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sel_id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupField</span> <span class='hs-varid'>field_lbl</span>
<a name="line-51"></a>		   <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>sel_id</span><span class='hs-layout'>,</span> <span class='hs-varid'>pat_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-52"></a>
<a name="line-53"></a>    <span class='hs-varid'>field_tys</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>FieldLabel</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-54"></a>    <span class='hs-varid'>field_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>con_like</span> <span class='hs-keyword'>of</span>
<a name="line-55"></a>        <span class='hs-conid'>RealDataCon</span> <span class='hs-varid'>data_con</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>zip</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConFieldLabels</span> <span class='hs-varid'>data_con</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg_tys</span>
<a name="line-56"></a>	  <span class='hs-comment'>-- Don't use zipEqual! If the constructor isn't really a record, then</span>
<a name="line-57"></a>	  <span class='hs-comment'>-- dataConFieldLabels will be empty (and each field in the pattern</span>
<a name="line-58"></a>	  <span class='hs-comment'>-- will generate an error below).</span>
<a name="line-59"></a>        <span class='hs-conid'>PatSynCon</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>[]</span>
<a name="line-60"></a>
<a name="line-61"></a><a name="conLikeArity"></a><span class='hs-definition'>conLikeArity</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ConLike</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Arity</span>
<a name="line-62"></a><span class='hs-definition'>conLikeArity</span> <span class='hs-layout'>(</span><span class='hs-conid'>RealDataCon</span> <span class='hs-varid'>data_con</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConSourceArity</span> <span class='hs-varid'>data_con</span>
<a name="line-63"></a><span class='hs-definition'>conLikeArity</span> <span class='hs-layout'>(</span><span class='hs-conid'>PatSynCon</span>   <span class='hs-varid'>pat_syn</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>patSynArity</span> <span class='hs-varid'>pat_syn</span>
<a name="line-64"></a>
<a name="line-65"></a><a name="tcConArg"></a><span class='hs-definition'>tcConArg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Checker</span> <span class='hs-layout'>(</span><span class='hs-conid'>LPat</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcSigmaType</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>LPat</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span>
<a name="line-66"></a><span class='hs-definition'>tcConArg</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_pat</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>penv</span> <span class='hs-varid'>thing_inside</span>
<a name="line-67"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_lpat</span> <span class='hs-varid'>arg_pat</span> <span class='hs-varid'>arg_ty</span> <span class='hs-varid'>penv</span> <span class='hs-varid'>thing_inside</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="addDataConStupidTheta"></a><span class='hs-definition'>addDataConStupidTheta</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-2"></a><span class='hs-comment'>-- Instantiate the "stupid theta" of the data con, and throw </span>
<a name="line-3"></a><span class='hs-comment'>-- the constraints into the constraint set</span>
<a name="line-4"></a><span class='hs-definition'>addDataConStupidTheta</span> <span class='hs-varid'>data_con</span> <span class='hs-varid'>inst_tys</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>stupid_theta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>	      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>instStupidTheta</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>inst_theta</span>
<a name="line-7"></a>  <span class='hs-keyword'>where</span>
<a name="line-8"></a>    <span class='hs-varid'>origin</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>OccurrenceOf</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConName</span> <span class='hs-varid'>data_con</span><span class='hs-layout'>)</span>
<a name="line-9"></a>	<span class='hs-comment'>-- The origin should always report "occurrence of C"</span>
<a name="line-10"></a>	<span class='hs-comment'>-- even when C occurs in a pattern</span>
<a name="line-11"></a>    <span class='hs-varid'>stupid_theta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConStupidTheta</span> <span class='hs-varid'>data_con</span>
<a name="line-12"></a>    <span class='hs-varid'>tenv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTopTvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConUnivTyVars</span> <span class='hs-varid'>data_con</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>inst_tys</span><span class='hs-layout'>)</span>
<a name="line-13"></a>    	 <span class='hs-comment'>-- NB: inst_tys can be longer than the univ tyvars</span>
<a name="line-14"></a>	 <span class='hs-comment'>--     because the constructor might have existentials</span>
<a name="line-15"></a>    <span class='hs-varid'>inst_theta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTheta</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>stupid_theta</span>
</pre>\end{code}

Note [Arrows and patterns]
~~~~~~~~~~~~~~~~~~~~~~~~~~
(Oct 07) Arrow noation has the odd property that it involves 
"holes in the scope". For example:
  expr :: Arrow a => a () Int
  expr = proc (y,z) -> do
          x <- term -< y
          expr' -< x

Here the 'proc (y,z)' binding scopes over the arrow tails but not the
arrow body (e.g 'term').  As things stand (bogusly) all the
constraints from the proc body are gathered together, so constraints
from 'term' will be seen by the tcPat for (y,z).  But we must *not*
bind constraints from 'term' here, because the desugarer will not make
these bindings scope over 'term'.

The Right Thing is not to confuse these constraints together. But for
now the Easy Thing is to ensure that we do not have existential or
GADT constraints in a 'proc', and to short-cut the constraint
simplification for such vanilla patterns so that it binds no
constraints. Hence the 'fast path' in tcConPat; but it's also a good
plan for ordinary vanilla patterns to bypass the constraint
simplification step.

%************************************************************************
%*									*
		Note [Pattern coercions]
%*									*
%************************************************************************

In principle, these program would be reasonable:
	
	f :: (forall a. a->a) -> Int
	f (x :: Int->Int) = x 3

	g :: (forall a. [a]) -> Bool
	g [] = True

In both cases, the function type signature restricts what arguments can be passed
in a call (to polymorphic ones).  The pattern type signature then instantiates this
type.  For example, in the first case,  (forall a. a->a) <= Int -> Int, and we
generate the translated term
	f = \x' :: (forall a. a->a).  let x = x' Int in x 3

From a type-system point of view, this is perfectly fine, but it's *very* seldom useful.
And it requires a significant amount of code to implement, because we need to decorate
the translated pattern with coercion functions (generated from the subsumption check 
by tcSub).  

So for now I'm just insisting on type *equality* in patterns.  No subsumption. 

Old notes about desugaring, at a time when pattern coercions were handled:

A SigPat is a type coercion and must be handled one at at time.  We can't
combine them unless the type of the pattern inside is identical, and we don't
bother to check for that.  For example:

	data T = T1 Int | T2 Bool
	f :: (forall a. a -> a) -> T -> t
	f (g::Int->Int)   (T1 i) = T1 (g i)
	f (g::Bool->Bool) (T2 b) = T2 (g b)

We desugar this as follows:

	f = \ g::(forall a. a->a) t::T ->
	    let gi = g Int
	    in case t of { T1 i -> T1 (gi i)
			   other ->
	    let	gb = g Bool
	    in case t of { T2 b -> T2 (gb b)
			   other -> fail }}

Note that we do not treat the first column of patterns as a
column of variables, because the coerced variables (gi, gb)
would be of different types.  So we get rather grotty code.
But I don't think this is a common case, and if it was we could
doubtless improve it.

Meanwhile, the strategy is:
	* treat each SigPat coercion (always non-identity coercions)
		as a separate block
	* deal with the stuff inside, and then wrap a binding round
		the result to bind the new variable (gi, gb, etc)


%************************************************************************
%*									*
\subsection{Errors and contexts}
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="maybeWrapPatCtxt"></a><span class='hs-definition'>maybeWrapPatCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Pat</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>b</span>
<a name="line-2"></a><span class='hs-comment'>-- Not all patterns are worth pushing a context</span>
<a name="line-3"></a><span class='hs-definition'>maybeWrapPatCtxt</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>tcm</span> <span class='hs-varid'>thing_inside</span> 
<a name="line-4"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>worth_wrapping</span> <span class='hs-varid'>pat</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcm</span> <span class='hs-varid'>thing_inside</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-varid'>msg</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tcm</span> <span class='hs-varop'>$</span> <span class='hs-varid'>popErrCtxt</span> <span class='hs-varid'>thing_inside</span>
<a name="line-6"></a>    			       <span class='hs-comment'>-- Remember to pop before doing thing_inside</span>
<a name="line-7"></a>  <span class='hs-keyword'>where</span>
<a name="line-8"></a>   <span class='hs-varid'>worth_wrapping</span> <span class='hs-layout'>(</span><span class='hs-conid'>VarPat</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-9"></a>   <span class='hs-varid'>worth_wrapping</span> <span class='hs-layout'>(</span><span class='hs-conid'>ParPat</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-10"></a>   <span class='hs-varid'>worth_wrapping</span> <span class='hs-layout'>(</span><span class='hs-conid'>AsPat</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-11"></a>   <span class='hs-varid'>worth_wrapping</span> <span class='hs-keyword'>_</span>  	      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-12"></a>   <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"In the pattern:"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>pat</span><span class='hs-layout'>)</span>
<a name="line-13"></a>
<a name="line-14"></a><a name="checkExistentials"></a><span class='hs-comment'>-----------------------------------------------</span>
<a name="line-15"></a><span class='hs-definition'>checkExistentials</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PatEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-16"></a>	  <span class='hs-comment'>-- See Note [Arrows and patterns]</span>
<a name="line-17"></a><span class='hs-definition'>checkExistentials</span> <span class='hs-conid'>[]</span> <span class='hs-keyword'>_</span>                                 <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-18"></a><span class='hs-definition'>checkExistentials</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>PE</span> <span class='hs-layout'>{</span> <span class='hs-varid'>pe_ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LetPat</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithTc</span> <span class='hs-varid'>existentialLetPat</span>
<a name="line-19"></a><span class='hs-definition'>checkExistentials</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>PE</span> <span class='hs-layout'>{</span> <span class='hs-varid'>pe_ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LamPat</span> <span class='hs-conid'>ProcExpr</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithTc</span> <span class='hs-varid'>existentialProcPat</span>
<a name="line-20"></a><span class='hs-definition'>checkExistentials</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>PE</span> <span class='hs-layout'>{</span> <span class='hs-varid'>pe_lazy</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithTc</span> <span class='hs-varid'>existentialLazyPat</span>
<a name="line-21"></a><span class='hs-definition'>checkExistentials</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>                                  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-22"></a>
<a name="line-23"></a><a name="existentialLazyPat"></a><span class='hs-definition'>existentialLazyPat</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span>
<a name="line-24"></a><span class='hs-definition'>existentialLazyPat</span>
<a name="line-25"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"An existential or GADT data constructor cannot be used"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-26"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"inside a lazy (~) pattern"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-27"></a>
<a name="line-28"></a><a name="existentialProcPat"></a><span class='hs-definition'>existentialProcPat</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span>
<a name="line-29"></a><span class='hs-definition'>existentialProcPat</span> 
<a name="line-30"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Proc patterns cannot use existential or GADT data constructors"</span><span class='hs-layout'>)</span>
<a name="line-31"></a>
<a name="line-32"></a><a name="existentialLetPat"></a><span class='hs-definition'>existentialLetPat</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span>
<a name="line-33"></a><span class='hs-definition'>existentialLetPat</span>
<a name="line-34"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>text</span> <span class='hs-str'>"My brain just exploded"</span><span class='hs-layout'>,</span>
<a name="line-35"></a>	  <span class='hs-varid'>text</span> <span class='hs-str'>"I can't handle pattern bindings for existential or GADT data constructors."</span><span class='hs-layout'>,</span>
<a name="line-36"></a>	  <span class='hs-varid'>text</span> <span class='hs-str'>"Instead, use a case-expression, or do-notation, to unpack the constructor."</span><span class='hs-keyglyph'>]</span>
<a name="line-37"></a>
<a name="line-38"></a><a name="badFieldCon"></a><span class='hs-definition'>badFieldCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ConLike</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-39"></a><span class='hs-definition'>badFieldCon</span> <span class='hs-varid'>con</span> <span class='hs-varid'>field</span>
<a name="line-40"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Constructor"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-41"></a>	  <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"does not have field"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>field</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-42"></a>
<a name="line-43"></a><a name="polyPatSig"></a><span class='hs-definition'>polyPatSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-44"></a><span class='hs-definition'>polyPatSig</span> <span class='hs-varid'>sig_ty</span>
<a name="line-45"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Illegal polymorphic type signature in pattern:"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-46"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span>
<a name="line-47"></a>
<a name="line-48"></a><a name="lazyUnliftedPatErr"></a><span class='hs-definition'>lazyUnliftedPatErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OutputableBndr</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Pat</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-49"></a><span class='hs-definition'>lazyUnliftedPatErr</span> <span class='hs-varid'>pat</span>
<a name="line-50"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithTc</span> <span class='hs-varop'>$</span>
<a name="line-51"></a>    <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"A lazy (~) pattern cannot contain unlifted types:"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-52"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>pat</span><span class='hs-layout'>)</span>
</pre>\end{code}
</body>
</html>
